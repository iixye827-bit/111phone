<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jellyfish导航</title>
    <style>
        /* [CSS样式 - 无需改动] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif; }
        :root { --day-color1: #f5f7fa; --day-color2: #e4eaf5; --night-color1: #1a1a2e; --night-color2: #16213e; --hold-border: #4299e1; --text-day: #2d3748; --text-night: #f0f2f5; --bg-day: #eef2f9; --bg-night: #1a1a2e; --shadow-light-day: rgba(255, 255, 255, 0.9); --shadow-dark-day: rgba(174, 190, 212, 0.4); --shadow-light-night: rgba(40, 45, 65, 0.9); --shadow-dark-night: rgba(0, 0, 0, 0.3); }
        body { min-height: 100vh; background: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%); padding: 20px; display: flex; flex-direction: column; align-items: center; transition: background 0.5s ease; touch-action: manipulation; overflow-x: hidden; }
        body.dark-mode { background: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%); --hold-border: #63b3ed; color: var(--text-night); }
        .title-card { width: 100%; max-width: 800px; padding: 40px 20px; margin: 20px 0; border-radius: 16px; box-shadow: 12px 12px 24px var(--shadow-dark-day), -12px -12px 24px var(--shadow-light-day); background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); text-align: center; transition: all 0.5s ease; }
        body.dark-mode .title-card { box-shadow: 12px 12px 24px var(--shadow-dark-night), -12px -12px 24px var(--shadow-light-night); background-color: rgba(30, 35, 55, 0.9); }
        .editable-title { font-size: 32px; color: var(--text-day); margin-bottom: 20px; cursor: pointer; padding: 6px 12px; border-radius: 8px; transition: all 0.3s ease; display: block; width: fit-content; margin: 0 auto 20px auto; user-select: none; }
        body.dark-mode .editable-title { color: var(--text-night); }
        .editable-title:hover { background-color: rgba(255, 255, 255, 0.8); }
        body.dark-mode .editable-title:hover { background-color: rgba(50, 55, 75, 0.8); }
        .editable-subtitle { font-size: 16px; color: #5a6778; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: all 0.3s ease; display: block; width: fit-content; margin: 0 auto; line-height: 1.5; user-select: none; }
        body.dark-mode .editable-subtitle { color: #c0c6cc; }
        .editable-subtitle:hover { background-color: rgba(255, 255, 255, 0.8); color: var(--text-day); }
        body.dark-mode .editable-subtitle:hover { background-color: rgba(50, 55, 75, 0.8); color: var(--text-night); }
        .nav-container { width: 100%; max-width: 1200px; margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; padding: 20px; position: relative; }
        .nav-btn { position: relative; padding: 22px 16px; border: none; border-radius: 14px; box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day); background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); font-size: 17px; font-weight: 600; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; text-align: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .nav-btn.hold { border: 2px solid var(--hold-border); transform: scale(1.02); z-index: 5; box-shadow: 8px 8px 16px rgba(174, 190, 212, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.8), 0 0 0 2px rgba(66, 153, 225, 0.3); }
        body.dark-mode .nav-btn { box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night); background-color: rgba(30, 35, 55, 0.9); color: var(--text-night); }
        body.dark-mode .nav-btn.hold { box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.4), -8px -8px 16px rgba(40, 45, 65, 0.8), 0 0 0 2px rgba(99, 179, 237, 0.3); }
        .nav-btn:hover { transform: translateY(-3px); background-color: #ffffff; }
        body.dark-mode .nav-btn:hover { background-color: rgba(40, 45, 65, 1); }
        .nav-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); transform: translateY(0); }
        body.dark-mode .nav-btn:active { box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.25), inset -6px -6px 12px rgba(40, 45, 65, 0.8); }
        .theme-toggle, .color-palette-btn, .sync-btn, .add-nav-btn, .manage-btn { position: fixed; bottom: 30px; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); background-color: rgba(255, 255, 255, 0.9); color: var(--text-day); font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 10; user-select: none; -webkit-tap-highlight-color: transparent; }
        .theme-toggle { right: 30px; }
        .add-nav-btn { right: 30px; bottom: 90px; font-size: 24px; }
        .manage-btn { right: 30px; bottom: 150px; font-size: 20px; }
        .manage-btn.active { background-color: var(--hold-border); color: white; }
        .color-palette-btn { left: 30px; }
        .sync-btn { left: 50%; transform: translateX(-50%); }
        body.dark-mode .theme-toggle, body.dark-mode .color-palette-btn, body.dark-mode .sync-btn, body.dark-mode .add-nav-btn, body.dark-mode .manage-btn { box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); background-color: rgba(30, 35, 55, 1); color: var(--text-night); }
        body.dark-mode .manage-btn.active { background-color: var(--hold-border); }
        .delete-icon { display: none; position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background-color: #f56565; color: white; border-radius: 50%; border: 2px solid white; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-container.management-active .delete-icon { display: block; }
        .nav-container.management-active .nav-btn { cursor: not-allowed; animation: wiggle 0.2s ease-in-out infinite alternate; }
        @keyframes wiggle { from { transform: rotate(-0.5deg); } to { transform: rotate(0.5deg); } }
        /* [Other modal styles remain the same] */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}.modal-overlay.show{display:flex;opacity:1}.modal-content{width:90%;background:var(--bg-day);color:var(--text-day);border-radius:16px;box-shadow:12px 12px 24px var(--shadow-dark-day),-12px -12px 24px var(--shadow-light-day);padding:25px;transition:transform .3s ease,background .5s ease,box-shadow .5s ease;transform:scale(.95)}.modal-overlay.show .modal-content{transform:scale(1)}body.dark-mode .modal-content{background:var(--bg-night);color:var(--text-night);box-shadow:12px 12px 24px var(--shadow-dark-night),-12px -12px 24px var(--shadow-light-night)}.modal-header{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:600;margin-bottom:20px}.modal-title-group{display:flex;align-items:center;gap:8px}.modal-header .close-btn,.modal-header .settings-btn{cursor:pointer;border:none;background:transparent;color:inherit;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.modal-header .close-btn{font-size:24px;font-weight:bold;width:36px;height:36px}.modal-header .settings-btn{font-size:20px;width:32px;height:32px}.modal-header .close-btn:hover,.modal-header .settings-btn:hover{background:rgba(0,0,0,0.05)}body.dark-mode .modal-header .close-btn:hover,body.dark-mode .modal-header .settings-btn:hover{background:rgba(255,255,255,0.08)}.modal-input,.modal-select{width:100%;padding:12px 15px;border:none;border-radius:10px;font-size:16px;background:var(--bg-day);color:var(--text-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day);transition:all .3s ease;caret-color:var(--hold-border)}body.dark-mode .modal-input,body.dark-mode .modal-select{background:var(--bg-night);color:var(--text-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-input:focus,.modal-select:focus{outline:none;box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day),0 0 0 2px var(--hold-border)}body.dark-mode .modal-input:focus,body.dark-mode .modal-select:focus{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night),0 0 0 2px var(--hold-border)}.modal-button{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:white;background:var(--hold-border);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .3s ease}body.dark-mode .modal-button{box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}.modal-button:active{box-shadow:inset 4px 4px 8px rgba(0,0,0,0.2),inset -4px -4px 8px rgba(255,255,255,0.7)}body.dark-mode .modal-button:active{box-shadow:inset 4px 4px 8px rgba(0,0,0,0.4),inset -4px -4px 8px rgba(255,255,255,0.2)}.modal-button:disabled{background:#9db2c2;cursor:not-allowed}#syncModal .modal-content{max-width:500px;max-height:80vh;display:flex;flex-direction:column}#syncModal .modal-body,#settingsModal .modal-body,#addNavModal .modal-body{display:flex;flex-direction:column;gap:15px;flex-grow:1;min-height:0}.file-list-container{flex-grow:1;overflow-y:auto;border-radius:10px;padding:5px;margin-top:10px;background:var(--bg-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode .file-list-container{background:var(--bg-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.file-list-container ul{list-style:none;padding:5px}.file-list-container li{padding:8px 15px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:background .2s;gap:10px}.file-list-container li:hover{background-color:rgba(0,0,0,0.05)}body.dark-mode .file-list-container li:hover{background-color:rgba(255,255,255,0.08)}.file-list-status{text-align:center;color:#889;padding:30px 10px}.file-info{flex-grow:1;cursor:pointer;min-width:0}.file-name{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:16px}.file-timestamp{font-size:12px;font-weight:300;color:#9A86A4}.delete-btn{background:transparent;border:none;cursor:pointer;padding:0;flex-shrink:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s,color .2s;color:#bbb;font-size:22px;font-weight:bold;line-height:1}.delete-btn:hover{background:#f0f0f0;color:#e53e3e}body.dark-mode .delete-btn{color:#889}body.dark-mode .delete-btn:hover{background:rgba(255,255,255,0.1);color:#fc8181}#settingsModal .modal-content,#addNavModal .modal-content{max-width:400px}#settingsModal .modal-body .form-section,#addNavModal .modal-body .form-section{display:flex;flex-direction:column;gap:8px}#settingsModal label,#addNavModal label{font-size:14px;color:#5a6778}body.dark-mode #settingsModal label,body.dark-mode #addNavModal label{color:#c0c6cc}.nav-type-selector{display:flex;gap:10px;border-radius:12px;padding:5px;background:var(--bg-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode .nav-type-selector{background:var(--bg-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.nav-type-selector input[type=radio]{display:none}.nav-type-selector label{flex:1;text-align:center;padding:10px;border-radius:8px;cursor:pointer;transition:all .3s ease;font-weight:600}.nav-type-selector input[type=radio]:checked+label{background:var(--hold-border);color:white;box-shadow:2px 2px 5px rgba(0,0,0,0.1)}#addNavModal .status-text{text-align:center;font-size:14px;color:#889;min-height:20px}
        @media (max-width: 480px) { .editable-title { font-size: 26px; } .editable-subtitle { font-size: 14px; } .title-card { padding: 30px 15px; } .nav-container { grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px; } .nav-btn { padding: 18px 10px; font-size: 15px; } .theme-toggle, .color-palette-btn, .sync-btn, .add-nav-btn, .manage-btn { width: 44px; height: 44px; bottom: 20px; font-size: 16px; } .add-nav-btn { bottom: 75px; font-size: 22px; } .manage-btn { bottom: 130px; font-size: 20px; } .color-palette-btn { left: 20px; } }
    </style>
</head>
<body>
    <div class="title-card">
        <h1 class="editable-title" id="title">Jellyfish导航</h1>
        <div class="editable-subtitle" id="subtitle">点击即可跳转 | By淡季水母</div>
    </div>
    <div class="nav-container" id="navContainer">
        <p id="loading-status" style="text-align: center; color: #889; width: 100%;">正在从云端加载配置...</p>
    </div>

    <button class="theme-toggle" id="themeBtn">🌞</button>
    <button class="sync-btn" id="syncBtn">☁️</button>
    <button class="color-palette-btn" id="colorBtn">🎨</button>
    <button class="add-nav-btn" id="addNavBtn" title="添加导航">+</button>
    <button class="manage-btn" id="manageBtn" title="管理模式">✏️</button>
    
    <!-- All modals remain unchanged -->
    <div class="modal-overlay" id="syncModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>数据云盘</span><button class="settings-btn" id="settingsBtn" title="设置GitHub信息">⚙️</button></div><button class="close-btn" data-modal-id="syncModal">&times;</button></div><div class="modal-body"><select id="buttonSelector" class="modal-select"></select><input type="file" id="fileUploader"><input type="text" id="fileNameInput" class="modal-input" placeholder="可修改文件名（可选）"><button id="uploadBtn" class="modal-button">上传文件</button><div class="file-list-container"><ul id="fileList"></ul><div id="fileListStatus" class="file-list-status">请选择一个分类</div></div></div></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>GitHub 配置</span></div><button class="close-btn" data-modal-id="settingsModal">&times;</button></div><div class="modal-body"><div class="form-section"><label for="githubRepoInput">仓库 (格式: 用户名/仓库名)</label><input type="text" id="githubRepoInput" class="modal-input" placeholder="例如: my-username/my-repo"></div><div class="form-section"><label for="githubTokenInput">Personal Access Token</label><input type="password" id="githubTokenInput" class="modal-input" placeholder="ghp_xxxxxxxxxx"></div><button id="saveSettingsBtn" class="modal-button">保存配置</button></div></div></div>
    <div class="modal-overlay" id="addNavModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>添加导航</span></div><button class="close-btn" data-modal-id="addNavModal">&times;</button></div><div class="modal-body"><div class="nav-type-selector"><input type="radio" id="type-link" name="nav-type" value="link" checked><label for="type-link">外部链接</label><input type="radio" id="type-upload" name="nav-type" value="upload"><label for="type-upload">上传项目</label></div><div class="form-section"><label for="newButtonNameInput">按钮名称</label><input type="text" id="newButtonNameInput" class="modal-input" placeholder="例如: 我的博客"></div><div id="link-section" class="form-section"><label for="newButtonUrlInput">网址链接</label><input type="text" id="newButtonUrlInput" class="modal-input" placeholder="https://example.com"></div><div id="upload-section" class="form-section" style="display: none;"><label>选择项目文件夹</label><button id="folderPickerBtn" class="modal-button" style="background: #5a6778;">点击选择文件夹</button><div class="status-text" id="folder-picker-status"></div></div><button id="createNavBtn" class="modal-button">确认创建</button><div class="status-text" id="upload-status"></div></div></div></div>

    <script>
    // [JS 全局变量及基础函数]
    let GITHUB_CONFIG = {};
    const SYNC_FOLDER = 'data_sync';
    const CONFIG_FILE_PATH = 'config.json';
    let configSha = null; // Stores the SHA of the config.json for updates
    let isManagementMode = false;
    let longPressTimer = null, sourceBtn = null, targetBtn = null, isLongPress = false;
    let localDirectoryHandle = null;

    const navContainer = document.getElementById('navContainer');
    const manageBtn = document.getElementById('manageBtn');

    // [核心功能: 云端配置管理 (config.json)]
    async function fetchConfigFromGithub() {
        if (!checkConfig(false)) return [];
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${CONFIG_FILE_PATH}`;
        try {
            const response = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, cache: 'no-cache' });
            if (response.status === 404) {
                console.log('config.json not found. Starting with a blank slate.');
                configSha = null; // No file exists
                return [];
            }
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            configSha = data.sha; // Store SHA for future updates
            return JSON.parse(atob(data.content));
        } catch (error) {
            console.error('Failed to fetch config from GitHub:', error);
            alert('无法从云端加载配置，请检查网络和GitHub配置。');
            return [];
        }
    }

    async function saveConfigToGithub(config, commitMessage) {
        if (!checkConfig(true)) return;
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${CONFIG_FILE_PATH}`;
        const content = btoa(JSON.stringify(config, null, 2)); // btoa encodes to Base64
        const body = { message: commitMessage, content: content, branch: 'main' };
        if (configSha) {
            body.sha = configSha; // Must include SHA if updating an existing file
        }

        try {
            const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify(body) });
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            const data = await response.json();
            configSha = data.content.sha; // Update SHA after successful save
            console.log('Configuration saved to GitHub successfully.');
        } catch (error) {
            console.error('Failed to save config to GitHub:', error);
            alert(`配置保存至云端失败: ${error.message}`);
        }
    }

    // [核心功能: 按钮交互与配置管理]
    function clearHoldClass() { document.querySelectorAll('.nav-btn.hold').forEach(btn => btn.classList.remove('hold')); }
    async function swapButtons(a, b) { if (!a || !b || a === b) return; const tempText = a.textContent, tempHref = a.dataset.href; a.textContent = b.textContent; a.dataset.href = b.dataset.href; b.textContent = tempText; b.dataset.href = tempHref; await saveCurrentConfig('Reorder buttons'); }
    async function saveCurrentConfig(commitMessage) { const config = []; document.querySelectorAll('.nav-btn').forEach(btn => config.push({ text: btn.textContent, href: btn.dataset.href })); await saveConfigToGithub(config, commitMessage); }

    function attachButtonListeners(btn) {
        function startLongPress(e) { if (isManagementMode) return; if(e.type === 'touchstart') e.preventDefault(); const touch = e.type.startsWith('touch') ? e.touches[0] : e; if(longPressTimer) clearTimeout(longPressTimer); longPressTimer = setTimeout(() => { isLongPress = true; sourceBtn = btn; sourceBtn.classList.add('hold'); document.addEventListener('mousemove', detectTarget); document.addEventListener('touchmove', detectTarget, { passive: false }); }, 300); }
        function endLongPress() { if (isManagementMode) return; clearTimeout(longPressTimer); if (isLongPress) { swapButtons(sourceBtn, targetBtn); setTimeout(() => isLongPress = false, 50); } sourceBtn = null; targetBtn = null; clearHoldClass(); document.removeEventListener('mousemove', detectTarget); document.removeEventListener('touchmove', detectTarget); }
        btn.addEventListener('mousedown', startLongPress); btn.addEventListener('touchstart', startLongPress); btn.addEventListener('mouseup', endLongPress); btn.addEventListener('touchend', endLongPress); btn.addEventListener('touchcancel', endLongPress);
        btn.addEventListener('click', function(e) { if (isManagementMode) { e.preventDefault(); return; } if (!isLongPress) { const href = this.dataset.href; if (href) window.location.href = href; } else { e.preventDefault(); } });
    }
    function detectTarget(e) { if (isManagementMode) return; e.preventDefault(); const touch = e.type.startsWith('touch') ? e.touches[0] : e; const hoverBtn = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.nav-btn'); if (hoverBtn && hoverBtn !== sourceBtn) { if (targetBtn) targetBtn.classList.remove('hold'); targetBtn = hoverBtn; targetBtn.classList.add('hold'); } }

    async function loadConfig() {
        navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889; width: 100%;">正在从云端加载配置...</p>';
        const config = await fetchConfigFromGithub();
        navContainer.innerHTML = '';
        if (config.length === 0) {
            navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889; width: 100%;">配置为空，请点击右下角 "+" 添加您的第一个导航按钮。</p>';
        } else {
            config.forEach(item => addNewButtonToDOM(item.text, item.href));
        }
    }
    
    // [核心功能: 管理模式]
    function toggleManagementMode() {
        isManagementMode = !isManagementMode;
        navContainer.classList.toggle('management-active', isManagementMode);
        manageBtn.classList.toggle('active', isManagementMode);
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const deleteIcon = btn.querySelector('.delete-icon');
            if (isManagementMode && !deleteIcon) {
                const icon = document.createElement('span');
                icon.className = 'delete-icon';
                icon.innerHTML = '&times;';
                icon.title = '删除此按钮';
                btn.appendChild(icon);
            } else if (!isManagementMode && deleteIcon) {
                deleteIcon.remove();
            }
        });
    }

    manageBtn.addEventListener('click', toggleManagementMode);

    navContainer.addEventListener('click', async (e) => {
        if (!e.target.classList.contains('delete-icon')) return;
        const btnToDelete = e.target.closest('.nav-btn');
        const buttonName = btnToDelete.textContent.replace('×', '').trim();
        const buttonHref = btnToDelete.dataset.href;

        if (!confirm(`确定要删除 "${buttonName}" 吗？\n警告：如果这是上传的项目，其在GitHub上的整个文件夹都将被永久删除！`)) return;
        
        // Optimistically remove from UI
        btnToDelete.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
        btnToDelete.style.transform = 'scale(0.8)';
        btnToDelete.style.opacity = '0';
        
        setTimeout(async () => {
            btnToDelete.remove();
            const isExternalLink = buttonHref.startsWith('http');
            if (!isExternalLink) {
                const folderPath = buttonHref.substring(0, buttonHref.lastIndexOf('/'));
                const success = await deleteGithubFolder(folderPath);
                if (!success) {
                    alert('删除云端文件夹失败，请检查控制台获取详细信息。正在重新加载页面以恢复状态...');
                    location.reload();
                    return;
                }
            }
            await saveCurrentConfig(`Delete button: ${buttonName}`);
        }, 300);
    });

    async function deleteGithubFolder(folderPath) {
        if (!checkConfig(true)) return false;
        const contentsUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${folderPath}`;
        try {
            // 1. Get all files in the folder
            const contentsResponse = await fetch(contentsUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } });
            if (!contentsResponse.ok) throw new Error(`Could not list folder contents: ${contentsResponse.statusText}`);
            const files = await contentsResponse.json();

            // 2. Create a delete promise for each file
            const deletePromises = files.map(file => {
                return fetch(file.url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` },
                    body: JSON.stringify({ message: `Delete file: ${file.path}`, sha: file.sha, branch: 'main' })
                });
            });

            // 3. Execute all delete promises
            const results = await Promise.all(deletePromises);
            for (const result of results) {
                if (!result.ok) {
                    console.error('A file deletion failed:', await result.json());
                    // Even if one fails, we tried. The config update will clean up the button.
                }
            }
            console.log(`Folder "${folderPath}" and its contents have been deleted.`);
            return true;
        } catch (error) {
            console.error(`Failed to delete folder "${folderPath}":`, error);
            return false;
        }
    }


    // [核心功能: 标题与主题 - 无重大变更]
    function saveTitleConfig() { localStorage.setItem('titleConfig', JSON.stringify({ title: document.getElementById('title').textContent, subtitle: document.getElementById('subtitle').textContent })); }
    function loadTitleConfig() { const d = localStorage.getItem('titleConfig'); if(d) { const {title, subtitle} = JSON.parse(d); document.getElementById('title').textContent = title; document.getElementById('subtitle').textContent = subtitle; } }
    document.getElementById('title').addEventListener('click', () => { if(isManagementMode) return; const n = prompt('请输入新标题：', document.getElementById('title').textContent); if (n?.trim()) { document.getElementById('title').textContent = n.trim(); saveTitleConfig(); } });
    document.getElementById('subtitle').addEventListener('click', () => { if(isManagementMode) return; const n = prompt('请输入新描述：', document.getElementById('subtitle').textContent); if (n !== null) { document.getElementById('subtitle').textContent = n.trim(); saveTitleConfig(); } });
    const themeBtn = document.getElementById('themeBtn'); function initTheme() { const t=localStorage.getItem('theme'); if (t==='dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark-mode'); themeBtn.textContent = '🌙'; } else { themeBtn.textContent = '🌞'; } }
    themeBtn.addEventListener('click', () => { document.body.classList.toggle('dark-mode'); const i=document.body.classList.contains('dark-mode'); themeBtn.textContent=i?'🌙':'🌞'; localStorage.setItem('theme', i?'dark':'light'); });
    const colorBtn = document.getElementById('colorBtn'), root = document.documentElement; function initColors() { const d1=localStorage.getItem('dayColor1')||'#f5f7fa', d2=localStorage.getItem('dayColor2')||'#e4eaf5', n1=localStorage.getItem('nightColor1')||'#1a1a2e', n2=localStorage.getItem('nightColor2')||'#16213e'; root.style.setProperty('--day-color1', d1); root.style.setProperty('--day-color2', d2); root.style.setProperty('--night-color1', n1); root.style.setProperty('--night-color2', n2); }
    colorBtn.addEventListener('click', () => { const cD1=getComputedStyle(root).getPropertyValue('--day-color1').trim(), cD2=getComputedStyle(root).getPropertyValue('--day-color2').trim(), cN1=getComputedStyle(root).getPropertyValue('--night-color1').trim(), cN2=getComputedStyle(root).getPropertyValue('--night-color2').trim(); const nD1=prompt('日间渐变1：',cD1), nD2=prompt('日间渐变2：',cD2), nN1=prompt('夜间渐变1：',cN1), nN2=prompt('夜间渐变2：',cN2); const isHex=(c)=> /^#([0-9A-F]{3,4}|[0-9A-F]{6}|[0-9A-F]{8})$/i.test(c); if(nD1&&isHex(nD1)){root.style.setProperty('--day-color1', nD1);localStorage.setItem('dayColor1',nD1);} if(nD2&&isHex(nD2)){root.style.setProperty('--day-color2',nD2);localStorage.setItem('dayColor2',nD2);} if(nN1&&isHex(nN1)){root.style.setProperty('--night-color1',nN1);localStorage.setItem('nightColor1',nN1);} if(nN2&&isHex(nN2)){root.style.setProperty('--night-color2',nN2);localStorage.setItem('nightColor2',nN2);} });

    // [核心功能: 弹窗管理 - 无重大变更]
    const syncModalElements = { buttonSelector: document.getElementById('buttonSelector'), fileList: document.getElementById('fileList'), fileListStatus: document.getElementById('fileListStatus'), fileUploader: document.getElementById('fileUploader'), fileNameInput: document.getElementById('fileNameInput'), uploadBtn: document.getElementById('uploadBtn'), githubRepoInput: document.getElementById('githubRepoInput'), githubTokenInput: document.getElementById('githubTokenInput'), saveSettingsBtn: document.getElementById('saveSettingsBtn') };
    function setupModals() { document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => document.getElementById(btn.dataset.modalId).classList.remove('show'))); document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', e => (e.target === modal) && modal.classList.remove('show'))); document.getElementById('syncBtn').addEventListener('click', () => { document.getElementById('syncModal').classList.add('show'); populateButtonSelector(); fetchFilesForSelectedButton(); }); document.getElementById('settingsBtn').addEventListener('click', () => { if (GITHUB_CONFIG.owner && GITHUB_CONFIG.repo) syncModalElements.githubRepoInput.value = `${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`; syncModalElements.githubTokenInput.value = GITHUB_CONFIG.token || ''; document.getElementById('settingsModal').classList.add('show'); }); document.getElementById('addNavBtn').addEventListener('click', () => document.getElementById('addNavModal').classList.add('show')); }

    // [核心功能: 数据云盘 (文件管理) - 无重大变更]
    function saveGithubConfig(config) { localStorage.setItem('githubConfig', JSON.stringify(config)); GITHUB_CONFIG = config; }
    function loadGithubConfig() { const savedConfig = localStorage.getItem('githubConfig'); if(savedConfig) GITHUB_CONFIG = JSON.parse(savedConfig); }
    function checkConfig(showAlert = true) { if (!GITHUB_CONFIG.owner || !GITHUB_CONFIG.repo || !GITHUB_CONFIG.token) { if (showAlert) alert(`请先配置GitHub仓库信息。\n(点击☁️按钮 -> 点击标题旁⚙️)`); return false; } return true; }
    syncModalElements.saveSettingsBtn.addEventListener('click', async () => { const [owner, repo] = syncModalElements.githubRepoInput.value.trim().split('/').map(s=>s.trim()); const token = syncModalElements.githubTokenInput.value.trim(); if (!owner || !repo || !token) { alert('请填写完整信息。'); return; } saveGithubConfig({ owner, repo, token, branch: 'main' }); alert('配置已保存！请刷新页面以加载云端配置。'); document.getElementById('settingsModal').classList.remove('show'); await loadConfig(); });
    function populateButtonSelector() { const currentSelection = syncModalElements.buttonSelector.value; syncModalElements.buttonSelector.innerHTML = ''; document.querySelectorAll('.nav-btn').forEach(btn => { const btnText = btn.textContent.replace('×', '').trim(); const option = document.createElement('option'); option.value = option.textContent = btnText; syncModalElements.buttonSelector.appendChild(option); }); if (Array.from(syncModalElements.buttonSelector.options).some(opt => opt.value === currentSelection)) syncModalElements.buttonSelector.value = currentSelection; }
    // ...[The rest of the file sync functions like fetchFilesForSelectedButton, deleteFile, forceDownload, etc., remain the same]
    syncModalElements.buttonSelector.addEventListener('change', fetchFilesForSelectedButton);syncModalElements.fileUploader.addEventListener('change', () => { if(syncModalElements.fileUploader.files.length > 0) syncModalElements.fileNameInput.value = syncModalElements.fileUploader.files[0].name; });async function fetchFilesForSelectedButton() {const selectedButtonName = syncModalElements.buttonSelector.value;syncModalElements.fileList.innerHTML = '';syncModalElements.fileListStatus.style.display = 'block';if (!selectedButtonName) { syncModalElements.fileListStatus.textContent = '请选择一个分类'; return; }if (!checkConfig(true)) { syncModalElements.fileListStatus.innerHTML = `尚未配置GitHub信息<br>请点击标题旁 ⚙️ 进行设置`; return; }syncModalElements.fileListStatus.textContent = '正在加载...';const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${SYNC_FOLDER}/${selectedButtonName}`;try {const response = await fetch(apiUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, cache: 'no-cache' });if (response.status === 404) { syncModalElements.fileListStatus.textContent = '该分类下暂无文件'; return; }if (!response.ok) throw new Error(`HTTP ${response.status}`);const files = await response.json();if (files.length === 0) { syncModalElements.fileListStatus.textContent = '该分类下暂无文件'; } else {syncModalElements.fileListStatus.textContent = '正在获取文件信息...';const filesWithDates = await Promise.all(files.map(async (file) => ({ ...file, commitDate: await getLatestCommitDate(file.path) })));filesWithDates.sort((a, b) => new Date(b.commitDate) - new Date(a.commitDate));syncModalElements.fileList.innerHTML = ''; syncModalElements.fileListStatus.style.display = 'none';filesWithDates.forEach(file => {const li = document.createElement('li');const fileInfo = document.createElement('div'); fileInfo.className = 'file-info'; fileInfo.dataset.downloadUrl = file.download_url; fileInfo.dataset.fileName = file.name;const fileNameSpan = document.createElement('span'); fileNameSpan.className = 'file-name'; fileNameSpan.textContent = file.name;const fileTimestampSpan = document.createElement('span'); fileTimestampSpan.className = 'file-timestamp'; fileTimestampSpan.textContent = new Date(file.commitDate).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });fileInfo.append(fileNameSpan, fileTimestampSpan);const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.title = '删除文件';li.append(fileInfo, deleteBtn); syncModalElements.fileList.appendChild(li);fileInfo.addEventListener('click', (e) => forceDownload(e.currentTarget.dataset.downloadUrl, e.currentTarget.dataset.fileName, fileInfo));deleteBtn.addEventListener('click', () => deleteFile(file.path, file.sha, li));});}} catch (error) { console.error('获取文件列表失败:', error); syncModalElements.fileListStatus.textContent = `加载失败，请检查网络或配置。`; }}async function getLatestCommitDate(filePath) { const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(filePath)}&page=1&per_page=1`; try { const response = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } }); if (!response.ok) return new Date(0).toISOString(); const commits = await response.json(); return commits[0]?.commit.committer.date || new Date(0).toISOString(); } catch (error) { console.error(`获取提交日期失败 for ${filePath}:`, error); return new Date(0).toISOString(); } }async function deleteFile(filePath, sha, listItemElement) { if (!confirm(`确定要永久删除文件 "${filePath.split('/').pop()}" 吗？此操作不可恢复。`)) return; listItemElement.style.opacity = '0.5'; const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`; try { const response = await fetch(apiUrl, { method: 'DELETE', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify({ message: `Delete file: ${filePath}`, sha: sha, branch: 'main' }) }); if (!response.ok) throw new Error(`删除失败: ${(await response.json()).message}`); listItemElement.remove(); if (syncModalElements.fileList.children.length === 0) { syncModalElements.fileListStatus.textContent = '该分类下暂无文件'; syncModalElements.fileListStatus.style.display = 'block'; } } catch (error) { console.error('删除文件失败:', error); alert(`删除文件失败: ${error.message}`); listItemElement.style.opacity = '1'; } }async function forceDownload(url, filename, element) { const originalName = element.querySelector('.file-name').textContent; element.querySelector('.file-name').textContent = '准备下载中...'; element.style.pointerEvents = 'none'; try { const response = await fetch(url); if (!response.ok) throw new Error(`下载请求失败: ${response.statusText}`); const blob = await response.blob(); const link = document.createElement('a'); link.href = window.URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); link.remove(); window.URL.revokeObjectURL(link.href); } catch (error) { console.error('Download error:', error); alert(`下载文件时出错: ${error.message}`); } finally { element.querySelector('.file-name').textContent = originalName; element.style.pointerEvents = 'auto'; } }syncModalElements.uploadBtn.addEventListener('click', async () => { if (!checkConfig()) return; const selectedButtonName = syncModalElements.buttonSelector.value, file = syncModalElements.fileUploader.files[0]; let fileName = syncModalElements.fileNameInput.value.trim() || (file && file.name); if (!selectedButtonName || !file || !fileName) { alert('请选择分类、文件，并确保文件名不为空。'); return; } syncModalElements.uploadBtn.disabled = true; syncModalElements.uploadBtn.textContent = '上传中...'; try { const content = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${SYNC_FOLDER}/${selectedButtonName}/${fileName}`; const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify({ message: `Upload ${fileName}`, content: content, branch: 'main' }) }); if (!response.ok) throw new Error(`上传失败: ${response.statusText}`); alert('上传成功！'); syncModalElements.fileUploader.value = ''; syncModalElements.fileNameInput.value = ''; fetchFilesForSelectedButton(); } catch (error) { console.error('上传失败:', error); alert(`上传失败: ${error.message}`); } finally { syncModalElements.uploadBtn.disabled = false; syncModalElements.uploadBtn.textContent = '上传文件'; } });

    // [核心功能: 新增导航]
    const addNavModalElements = { typeLink: document.getElementById('type-link'), typeUpload: document.getElementById('type-upload'), linkSection: document.getElementById('link-section'), uploadSection: document.getElementById('upload-section'), nameInput: document.getElementById('newButtonNameInput'), urlInput: document.getElementById('newButtonUrlInput'), folderPickerBtn: document.getElementById('folderPickerBtn'), folderStatus: document.getElementById('folder-picker-status'), createBtn: document.getElementById('createNavBtn'), uploadStatus: document.getElementById('upload-status') };
    function addNewButtonToDOM(text, href) { if (navContainer.querySelector('#loading-status')) navContainer.innerHTML = ''; const newBtn = document.createElement('button'); newBtn.className = 'nav-btn'; newBtn.textContent = text; newBtn.dataset.href = href; navContainer.appendChild(newBtn); attachButtonListeners(newBtn); if (isManagementMode) { const icon = document.createElement('span'); icon.className = 'delete-icon'; icon.innerHTML = '&times;'; icon.title = '删除此按钮'; newBtn.appendChild(icon); } }
    addNavModalElements.typeLink.addEventListener('change', () => { addNavModalElements.linkSection.style.display = 'flex'; addNavModalElements.uploadSection.style.display = 'none'; }); addNavModalElements.typeUpload.addEventListener('change', () => { addNavModalElements.linkSection.style.display = 'none'; addNavModalElements.uploadSection.style.display = 'flex'; });
    addNavModalElements.folderPickerBtn.addEventListener('click', async () => { if (!window.showDirectoryPicker) { alert('您的浏览器不支持文件夹选择功能。'); return; } try { localDirectoryHandle = await window.showDirectoryPicker(); addNavModalElements.folderStatus.textContent = `已选择: ${localDirectoryHandle.name}`; } catch (err) { console.log('用户取消了文件夹选择'); } });
    function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); }
    async function getFilesInDirectory(dirHandle, path = '') { const files = []; for await (const entry of dirHandle.values()) { const newPath = path ? `${path}/${entry.name}` : entry.name; if (entry.kind === 'file') { const file = await entry.getFile(); files.push({ file, path: newPath }); } else if (entry.kind === 'directory') { files.push(...await getFilesInDirectory(entry, newPath)); } } return files; }

    addNavModalElements.createBtn.addEventListener('click', async () => {
        const buttonName = addNavModalElements.nameInput.value.trim();
        if (!buttonName) { alert('请输入按钮名称。'); return; }
        const navType = document.querySelector('input[name="nav-type"]:checked').value;
        addNavModalElements.createBtn.disabled = true; addNavModalElements.createBtn.textContent = '处理中...';
        try {
            let newButton;
            if (navType === 'link') { const url = addNavModalElements.urlInput.value.trim(); if (!url) { alert('请输入网址链接。'); return; } newButton = { text: buttonName, href: url }; } 
            else if (navType === 'upload') {
                if (!checkConfig()) return;
                if (!localDirectoryHandle) { alert('请选择一个项目文件夹。'); return; }
                const filesToUpload = await getFilesInDirectory(localDirectoryHandle);
                const safePath = buttonName.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g, '').replace(/\s+/g, '-') || `project-${Date.now()}`;
                if (!filesToUpload.some(f => f.path.endsWith('index.html'))) { alert('错误：文件夹中必须包含 index.html 文件。'); return; }
                for (let i = 0; i < filesToUpload.length; i++) {
                    const { file, path } = filesToUpload[i];
                    addNavModalElements.uploadStatus.textContent = `上传中 ${i + 1}/${filesToUpload.length}: ${path}`;
                    const content = await fileToBase64(file);
                    const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${safePath}/${path}`;
                    const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify({ message: `Create ${path}`, content: content, branch: GITHUB_CONFIG.branch || 'main' }) });
                    if (!response.ok) throw new Error(`上传 ${path} 失败: ${response.statusText}`);
                }
                newButton = { text: buttonName, href: `${safePath}/index.html` };
                alert('项目上传并发布成功！');
            }
            addNewButtonToDOM(newButton.text, newButton.href);
            await saveCurrentConfig(`Add button: ${newButton.text}`);
            document.getElementById('addNavModal').classList.remove('show');
        } catch(error) { console.error('创建导航失败:', error); alert(`操作失败: ${error.message}`); addNavModalElements.uploadStatus.textContent = `操作失败!`; } 
        finally { 
            addNavModalElements.createBtn.disabled = false; addNavModalElements.createBtn.textContent = '确认创建'; 
            addNavModalElements.nameInput.value = ''; addNavModalElements.urlInput.value = ''; addNavModalElements.folderStatus.textContent = ''; addNavModalElements.uploadStatus.textContent = '';
            localDirectoryHandle = null;
        }
    });

    // [页面加载初始化]
    window.addEventListener('load', async () => {
        loadTitleConfig();
        initTheme();
        initColors();
        loadGithubConfig();
        await loadConfig();
        setupModals();
    });
    </script>
</body>
</html>
