<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jellyfish导航</title>
    <style>
        /* [CSS样式 - 包含V4.0重大更新] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif; }
        :root { --day-color1: #f5f7fa; --day-color2: #e4eaf5; --night-color1: #1a1a2e; --night-color2: #16213e; --hold-border: #4299e1; --text-day: #2d3748; --text-night: #f0f2f5; --bg-day: #eef2f9; --bg-night: #1a1a2e; --shadow-light-day: rgba(255, 255, 255, 0.9); --shadow-dark-day: rgba(174, 190, 212, 0.4); --shadow-light-night: rgba(40, 45, 65, 0.9); --shadow-dark-night: rgba(0, 0, 0, 0.3); }
        body { min-height: 100vh; background: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%); padding: 20px; display: flex; flex-direction: column; align-items: center; transition: background 0.5s ease; touch-action: manipulation; overflow-x: hidden; }
        body.dark-mode { background: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%); --hold-border: #63b3ed; color: var(--text-night); }
        .title-card { width: 100%; max-width: 800px; padding: 40px 20px; margin: 20px 0; border-radius: 16px; box-shadow: 12px 12px 24px var(--shadow-dark-day), -12px -12px 24px var(--shadow-light-day); background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); text-align: center; transition: all 0.5s ease; }
        body.dark-mode .title-card { box-shadow: 12px 12px 24px var(--shadow-dark-night), -12px -12px 24px var(--shadow-light-night); background-color: rgba(30, 35, 55, 0.9); }
        .editable-title { font-size: 32px; color: var(--text-day); margin-bottom: 20px; cursor: pointer; padding: 6px 12px; border-radius: 8px; transition: all 0.3s ease; display: block; width: fit-content; margin: 0 auto 20px auto; user-select: none; }
        body.dark-mode .editable-title { color: var(--text-night); }
        .editable-title:hover { background-color: rgba(255, 255, 255, 0.8); }
        body.dark-mode .editable-title:hover { background-color: rgba(50, 55, 75, 0.8); }
        .editable-subtitle { font-size: 16px; color: #5a6778; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: all 0.3s ease; display: block; width: fit-content; margin: 0 auto; line-height: 1.5; user-select: none; }
        body.dark-mode .editable-subtitle { color: #c0c6cc; }
        .editable-subtitle:hover { background-color: rgba(255, 255, 255, 0.8); color: var(--text-day); }
        body.dark-mode .editable-subtitle:hover { background-color: rgba(50, 55, 75, 0.8); color: var(--text-night); }
        .nav-container { width: 100%; max-width: 1200px; margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; padding: 20px; position: relative; }
        .nav-btn { position: relative; padding: 22px 16px; border: none; border-radius: 14px; box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day); background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); font-size: 17px; font-weight: 600; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; text-align: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .nav-btn.hold { border: 2px solid var(--hold-border); transform: scale(1.02); z-index: 5; box-shadow: 8px 8px 16px rgba(174, 190, 212, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.8), 0 0 0 2px rgba(66, 153, 225, 0.3); }
        body.dark-mode .nav-btn { box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night); background-color: rgba(30, 35, 55, 0.9); color: var(--text-night); }
        body.dark-mode .nav-btn.hold { box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.4), -8px -8px 16px rgba(40, 45, 65, 0.8), 0 0 0 2px rgba(99, 179, 237, 0.3); }
        .nav-btn:hover { transform: translateY(-3px); background-color: #ffffff; }
        body.dark-mode .nav-btn:hover { background-color: rgba(40, 45, 65, 1); }
        .nav-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); transform: translateY(0); }
        body.dark-mode .nav-btn:active { box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.25), inset -6px -6px 12px rgba(40, 45, 65, 0.8); }
        .delete-icon { display: none; position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background-color: #f56565; color: white; border-radius: 50%; border: 2px solid white; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); z-index: 99; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .page-overlay.show { opacity: 1; pointer-events: auto; }
        .page-overlay.management-overlay { background: transparent; backdrop-filter: none; }
        .management-active .nav-btn { cursor: move; animation: wiggle 0.2s ease-in-out infinite alternate; pointer-events: auto !important; }
        .management-active .nav-btn > .delete-icon { display: block; }
        @keyframes wiggle { from { transform: rotate(-0.5deg); } to { transform: rotate(0.5deg); } }
        .fab-container { position: fixed; right: 30px; bottom: 30px; z-index: 100; }
        .fab-main, .fab-drawer-item { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); background-color: rgba(255, 255, 255, 0.9); color: var(--text-day); font-size: 22px; display: flex; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        body.dark-mode .fab-main, body.dark-mode .fab-drawer-item { box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); background-color: rgba(30, 35, 55, 1); color: var(--text-night); }
        .fab-main:active, .fab-drawer-item:active { transform: scale(0.95); }
        .fab-container.active .fab-main { transform: rotate(45deg); }
        .fab-drawer { position: absolute; bottom: 65px; left: 0; display: flex; flex-direction: column; gap: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; }
        .fab-container.active .fab-drawer { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}.modal-overlay.show{display:flex;opacity:1}.modal-content{width:90%;background:var(--bg-day);color:var(--text-day);border-radius:16px;box-shadow:12px 12px 24px var(--shadow-dark-day),-12px -12px 24px var(--shadow-light-day);padding:25px;transition:transform .3s ease,background .5s ease,box-shadow .5s ease;transform:scale(.95)}.modal-overlay.show .modal-content{transform:scale(1)}body.dark-mode .modal-content{background:var(--bg-night);color:var(--text-night);box-shadow:12px 12px 24px var(--shadow-dark-night),-12px -12px 24px var(--shadow-light-night)}.modal-header{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:600;margin-bottom:20px}.modal-title-group{display:flex;align-items:center;gap:8px}.modal-header .close-btn,.modal-header .settings-btn{cursor:pointer;border:none;background:transparent;color:inherit;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.modal-header .close-btn{font-size:24px;font-weight:bold;width:36px;height:36px}.modal-header .settings-btn{font-size:20px;width:32px;height:32px}.modal-header .close-btn:hover,.modal-header .settings-btn:hover{background:rgba(0,0,0,0.05)}body.dark-mode .modal-header .close-btn:hover,body.dark-mode .modal-header .settings-btn:hover{background:rgba(255,255,255,0.08)}.modal-input,.modal-select{width:100%;padding:12px 15px;border:none;border-radius:10px;font-size:16px;background:var(--bg-day);color:var(--text-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day);transition:all .3s ease;caret-color:var(--hold-border)}body.dark-mode .modal-input,body.dark-mode .modal-select{background:var(--bg-night);color:var(--text-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-input:focus,.modal-select:focus{outline:none;box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day),0 0 0 2px var(--hold-border)}body.dark-mode .modal-input:focus,body.dark-mode .modal-select:focus{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night),0 0 0 2px var(--hold-border)}.modal-button{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:white;background:var(--hold-border);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .3s ease}body.dark-mode .modal-button{box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}.modal-button:active{box-shadow:inset 4px 4px 8px rgba(0,0,0,0.2),inset -4px -4px 8px rgba(255,255,255,0.7)}body.dark-mode .modal-button:active{box-shadow:inset 4px 4px 8px rgba(0,0,0,0.4),inset -4px -4px 8px rgba(255,255,255,0.2)}.modal-button:disabled{background:#9db2c2;cursor:not-allowed}#syncModal .modal-content,#colorPaletteModal .modal-content{max-width:500px;max-height:80vh;display:flex;flex-direction:column}#syncModal .modal-body,#settingsModal .modal-body,#addNavModal .modal-body, #colorPaletteModal .modal-body{display:flex;flex-direction:column;gap:15px;flex-grow:1;min-height:0}#addNavModal .modal-body { gap: 20px; }
        #colorPaletteModal .modal-body { gap: 20px; max-width: 450px; margin: 0 auto;}
        .color-picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .color-picker-group { display: flex; flex-direction: column; gap: 8px; }
        .color-picker-group label { font-size: 14px; color: #5a6778; } body.dark-mode .color-picker-group label { color: #c0c6cc; }
        .color-input-wrapper { display: flex; align-items: center; border-radius: 10px; padding: 5px; background:var(--bg-day); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .color-input-wrapper { background:var(--bg-night); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        input[type="color"] { width: 40px; height: 30px; border: none; background: transparent; cursor: pointer; -webkit-appearance: none; padding: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: none; }
        .hex-input { flex-grow: 1; background: transparent; border: none; outline: none; font-size: 16px; padding-left: 10px; color: inherit; }
        .preset-manager { border-top: 1px solid rgba(0,0,0,0.1); body.dark-mode & { border-color: rgba(255,255,255,0.1); } padding-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .preset-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .random-toggle-section { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background:var(--bg-day); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .random-toggle-section { background:var(--bg-night); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hold-border); } input:checked + .slider:before { transform: translateX(22px); }
        #file-list-container{flex-grow:1;overflow-y:auto;border-radius:10px;padding:5px;margin-top:10px;background:var(--bg-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode #file-list-container{background:var(--bg-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}#file-list-container ul{list-style:none;padding:5px}#file-list-container li{padding:8px 15px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:background .2s;gap:10px}#file-list-container li:hover{background-color:rgba(0,0,0,0.05)}body.dark-mode #file-list-container li:hover{background-color:rgba(255,255,255,0.08)}#file-list-status{text-align:center;color:#889;padding:30px 10px}.file-info{flex-grow:1;cursor:pointer;min-width:0}.file-name{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:16px}.file-timestamp{font-size:12px;font-weight:300;color:#9A86A4}.delete-btn{background:transparent;border:none;cursor:pointer;padding:0;flex-shrink:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s,color .2s;color:#bbb;font-size:22px;font-weight:bold;line-height:1}.delete-btn:hover{background:#f0f0f0;color:#e53e3e}body.dark-mode .delete-btn{color:#889}body.dark-mode .delete-btn:hover{background:rgba(255,255,255,0.1);color:#fc8181}#settingsModal .modal-content,#addNavModal .modal-content{max-width:400px}#settingsModal .modal-body .form-section,#addNavModal .modal-body .form-section{display:flex;flex-direction:column;gap:8px}#settingsModal label,#addNavModal label{font-size:14px;color:#5a6778}body.dark-mode #settingsModal label,body.dark-mode #addNavModal label{color:#c0c6cc}.nav-type-selector{display:flex;gap:10px;border-radius:12px;padding:5px;background:var(--bg-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode .nav-type-selector{background:var(--bg-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.nav-type-selector input[type=radio]{display:none}.nav-type-selector label{flex:1;text-align:center;padding:10px;border-radius:8px;cursor:pointer;transition:all .3s ease;font-weight:600}.nav-type-selector input[type=radio]:checked+label{background:var(--hold-border);color:white;box-shadow:2px 2px 5px rgba(0,0,0,0.1)}#addNavModal .status-text{text-align:center;font-size:14px;color:#889;min-height:20px}
        @media (max-width: 480px) { .editable-title { font-size: 26px; } .editable-subtitle { font-size: 14px; } .title-card { padding: 30px 15px; } .nav-container { grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px; } .nav-btn { padding: 18px 10px; font-size: 15px; } .fab-container { right: 20px; bottom: 20px; } .fab-main, .fab-drawer-item { width: 44px; height: 44px; font-size: 20px; } .fab-drawer { bottom: 55px; } .color-picker-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="page-overlay" id="pageOverlay"></div>

    <div class="title-card">
        <h1 class="editable-title" id="title">Jellyfish导航</h1>
        <div class="editable-subtitle" id="subtitle">点击即可跳转 | By淡季水母</div>
    </div>
    <div class="nav-container" id="navContainer">
        <p id="loading-status" style="text-align: center; color: #889; width: 100%;">正在从云端加载配置...</p>
    </div>

    <div class="fab-container" id="fabContainer">
        <div class="fab-drawer" id="fabDrawer">
            <button class="fab-drawer-item" id="colorBtn" title="主题配色">🎨</button>
            <button class="fab-drawer-item" id="syncBtn" title="数据云盘">☁️</button>
            <button class="fab-drawer-item" id="addNavBtn" title="添加/管理导航">+</button>
        </div>
        <button class="fab-main theme-toggle" id="themeBtn" title="切换主题">🌞</button>
    </div>
    
    <!-- All modals -->
    <div class="modal-overlay" id="addNavModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>添加/管理导航</span></div><button class="close-btn" data-modal-id="addNavModal">&times;</button></div><div class="modal-body"><button id="enterManageModeBtn" class="modal-button" style="background: #5a6778; margin-bottom: 20px;">进入管理模式</button><div class="nav-type-selector"><input type="radio" id="type-link" name="nav-type" value="link" checked><label for="type-link">外部链接</label><input type="radio" id="type-upload" name="nav-type" value="upload"><label for="type-upload">上传项目</label></div><div class="form-section"><label for="newButtonNameInput">按钮名称</label><input type="text" id="newButtonNameInput" class="modal-input" placeholder="例如: 我的博客"></div><div id="link-section" class="form-section"><label for="newButtonUrlInput">网址链接</label><input type="text" id="newButtonUrlInput" class="modal-input" placeholder="https://example.com"></div><div id="upload-section" class="form-section" style="display: none;"><label>选择项目文件夹</label><button id="folderPickerBtn" class="modal-button" style="background: #5a6778;">点击选择文件夹</button><div class="status-text" id="folder-picker-status"></div></div><button id="createNavBtn" class="modal-button">创建新导航</button><div class="status-text" id="upload-status"></div></div></div></div>
    <div class="modal-overlay" id="syncModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>数据云盘</span><button class="settings-btn" id="settingsBtn" title="设置GitHub信息">⚙️</button></div><button class="close-btn" data-modal-id="syncModal">&times;</button></div><div class="modal-body"><select id="buttonSelector" class="modal-select"></select><input type="file" id="fileUploader"><input type="text" id="fileNameInput" class="modal-input" placeholder="可修改文件名（可选）"><button id="uploadBtn" class="modal-button">上传文件</button><div id="file-list-container"><ul id="fileList"></ul><div id="fileListStatus" class="file-list-status">请选择一个分类</div></div></div></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>GitHub 配置</span></div><button class="close-btn" data-modal-id="settingsModal">&times;</button></div><div class="modal-body"><div class="form-section"><label for="githubRepoInput">仓库 (格式: 用户名/仓库名)</label><input type="text" id="githubRepoInput" class="modal-input" placeholder="例如: my-username/my-repo"></div><div class="form-section"><label for="githubTokenInput">Personal Access Token</label><input type="password" id="githubTokenInput" class="modal-input" placeholder="ghp_xxxxxxxxxx"></div><button id="saveSettingsBtn" class="modal-button">保存配置</button></div></div></div>
    <div class="modal-overlay" id="colorPaletteModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>水母调色板</span></div><button class="close-btn" data-modal-id="colorPaletteModal">&times;</button></div><div class="modal-body"><div class="color-picker-grid"><div class="color-picker-group"><label for="dayColor1">日间模式 - 渐变1</label><div class="color-input-wrapper"><input type="color" id="dayColor1Picker"><input type="text" class="hex-input" id="dayColor1Hex"></div></div><div class="color-picker-group"><label for="dayColor2">日间模式 - 渐变2</label><div class="color-input-wrapper"><input type="color" id="dayColor2Picker"><input type="text" class="hex-input" id="dayColor2Hex"></div></div><div class="color-picker-group"><label for="nightColor1">夜间模式 - 渐变1</label><div class="color-input-wrapper"><input type="color" id="nightColor1Picker"><input type="text" class="hex-input" id="nightColor1Hex"></div></div><div class="color-picker-group"><label for="nightColor2">夜间模式 - 渐变2</label><div class="color-input-wrapper"><input type="color" id="nightColor2Picker"><input type="text" class="hex-input" id="nightColor2Hex"></div></div></div><div class="preset-manager"><input type="text" id="presetNameInput" class="modal-input" placeholder="为当前配色方案命名"><div class="preset-actions"><button id="savePresetBtn" class="modal-button" style="background:#28a745">保存为新预设</button><button id="updatePresetBtn" class="modal-button">更新选中预设</button></div><select id="presetSelector" class="modal-select"></select><button id="deletePresetBtn" class="modal-button" style="background:#dc3545">删除选中预设</button></div><div class="random-toggle-section"><span>每次启动时随机应用预设</span><label class="toggle-switch"><input type="checkbox" id="randomPaletteToggle"><span class="slider"></span></label></div></div></div></div>

    <script>
    // [JS 全局变量及基础函数]
    let GITHUB_CONFIG = {}; const SYNC_FOLDER = 'data_sync', CONFIG_FILE_PATH = 'config.json';
    let configSha = null, isManagementMode = false, longPressTimer = null, sourceBtn = null, targetBtn = null, isLongPress = false, localDirectoryHandle = null;
    const navContainer = document.getElementById('navContainer'), pageOverlay = document.getElementById('pageOverlay');

    // [CORE FUNCTION: Floating Action Button (FAB) Hub]
    const fabContainer = document.getElementById('fabContainer'), fabMainBtn = document.getElementById('themeBtn');
    let fabPressTimer = null, isFabLongPress = false;
    function toggleFabMenu(forceState) {
        const isActive = forceState !== undefined ? forceState : !fabContainer.classList.contains('active');
        fabContainer.classList.toggle('active', isActive);
        if (!isManagementMode) pageOverlay.classList.toggle('show', isActive);
    }
    fabMainBtn.addEventListener('mousedown', (e) => { e.preventDefault(); isFabLongPress = false; fabPressTimer = setTimeout(() => { isFabLongPress = true; toggleFabMenu(true); }, 300); });
    fabMainBtn.addEventListener('mouseup', () => { clearTimeout(fabPressTimer); if (!isFabLongPress) { fabContainer.classList.contains('active') ? toggleFabMenu(false) : toggleTheme(); } });
    fabMainBtn.addEventListener('contextmenu', e => e.preventDefault());
    fabMainBtn.addEventListener('touchstart', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mousedown')); }, { passive: false });
    fabMainBtn.addEventListener('touchend', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mouseup')); }, { passive: false });

    // [CORE FUNCTION: Cloud Sync (config.json) - Unchanged]
    async function fetchConfigFromGithub(){if(!checkConfig(false))return[];const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${CONFIG_FILE_PATH}`;try{const response=await fetch(url,{headers:{'Authorization':`token ${GITHUB_CONFIG.token}`},cache:'no-cache'});if(response.status===404){console.log('config.json not found. Starting with a blank slate.');configSha=null;return[]}if(!response.ok)throw new Error(`HTTP ${response.status}`);const data=await response.json();configSha=data.sha;return JSON.parse(atob(data.content))}catch(error){console.error('Failed to fetch config from GitHub:',error);alert('无法从云端加载配置，请检查网络和GitHub配置。');return[]}}
    async function saveConfigToGithub(config,commitMessage){if(!checkConfig(true))return;const url=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${CONFIG_FILE_PATH}`;const content=btoa(JSON.stringify(config,null,2));const body={message:commitMessage,content:content,branch:'main'};if(configSha){body.sha=configSha}try{const response=await fetch(url,{method:'PUT',headers:{'Authorization':`token ${GITHUB_CONFIG.token}`},body:JSON.stringify(body)});if(!response.ok)throw new Error(`HTTP ${response.status}: ${await response.text()}`);const data=await response.json();configSha=data.content.sha;console.log('Configuration saved to GitHub successfully.')}catch(error){console.error('Failed to save config to GitHub:',error);alert(`配置保存至云端失败: ${error.message}`)}}

    // [CORE FUNCTION: Management Mode & Button Interaction]
    function clearHoldClass() { document.querySelectorAll('.nav-btn.hold').forEach(btn => btn.classList.remove('hold')); }
    async function swapButtons(a, b) { if (!a || !b || a === b) return; a.parentElement.insertBefore(a, b.nextSibling === a ? b : b.nextSibling); await saveCurrentConfig('Reorder buttons'); }
    async function saveCurrentConfig(commitMessage) { const config = []; document.querySelectorAll('.nav-btn').forEach(btn => config.push({ text: btn.textContent.replace('×', '').trim(), href: btn.dataset.href })); await saveConfigToGithub(config, commitMessage); }
    function attachButtonListeners(btn) {
        function startDrag(e) { if (!isManagementMode) return; if(e.type === 'touchstart') e.preventDefault(); longPressTimer = setTimeout(() => { isLongPress = true; sourceBtn = btn; sourceBtn.classList.add('hold'); document.addEventListener('mousemove', detectTarget); document.addEventListener('touchmove', detectTarget, { passive: false }); }, 200); }
        function endDrag() { if (!isManagementMode) return; clearTimeout(longPressTimer); if (isLongPress) { swapButtons(sourceBtn, targetBtn).finally(()=>setTimeout(() => isLongPress = false, 50)); } sourceBtn = null; targetBtn = null; clearHoldClass(); document.removeEventListener('mousemove', detectTarget); document.removeEventListener('touchmove', detectTarget); }
        btn.addEventListener('mousedown', startDrag); btn.addEventListener('touchstart', startDrag); btn.addEventListener('mouseup', endDrag); btn.addEventListener('touchend', endDrag); btn.addEventListener('touchcancel', endDrag); btn.addEventListener('click', function(e) { if (isManagementMode || isLongPress) { e.preventDefault(); return; } const href = this.dataset.href; if (href) window.location.href = href; });
    }
    function detectTarget(e) { e.preventDefault(); const touch = e.type.startsWith('touch') ? e.touches[0] : e; const hoverBtn = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.nav-btn'); if (hoverBtn && hoverBtn !== sourceBtn) { if (targetBtn) targetBtn.classList.remove('hold'); targetBtn = hoverBtn; targetBtn.classList.add('hold'); } }
    function toggleManagementMode(forceState) {
        isManagementMode = forceState !== undefined ? forceState : !isManagementMode;
        pageOverlay.classList.toggle('show', isManagementMode);
        pageOverlay.classList.toggle('management-overlay', isManagementMode);
        document.body.classList.toggle('management-active', isManagementMode);
        document.querySelectorAll('.nav-btn').forEach(btn => { const deleteIcon = btn.querySelector('.delete-icon'); if (isManagementMode && !deleteIcon) { const icon = document.createElement('span'); icon.className = 'delete-icon'; icon.innerHTML = '&times;'; icon.title = '删除此按钮'; btn.appendChild(icon); } else if (!isManagementMode && deleteIcon) { deleteIcon.remove(); } });
    }
    document.getElementById('enterManageModeBtn').addEventListener('click', () => { document.getElementById('addNavModal').classList.remove('show'); setTimeout(() => toggleManagementMode(true), 150); });
    pageOverlay.addEventListener('click', () => { if (isManagementMode) toggleManagementMode(false); if (fabContainer.classList.contains('active')) toggleFabMenu(false); });
    navContainer.addEventListener('click', async (e) => { if (!e.target.classList.contains('delete-icon')) return; const btnToDelete = e.target.closest('.nav-btn'); const buttonName = btnToDelete.textContent.replace('×', '').trim(); if (!confirm(`确定要删除 "${buttonName}" 吗？\n警告：如果这是上传的项目，其在GitHub上的整个文件夹都将被永久删除！`)) return; btnToDelete.style.cssText = 'transition: all 0.3s ease; transform: scale(0.8); opacity: 0;'; setTimeout(async () => { btnToDelete.remove(); const isExternalLink = btnToDelete.dataset.href.startsWith('http'); if (!isExternalLink) { const success = await deleteGithubFolder(btnToDelete.dataset.href.substring(0, btnToDelete.dataset.href.lastIndexOf('/'))); if (!success) { alert('删除云端文件夹失败!'); location.reload(); return; } } await saveCurrentConfig(`Delete button: ${buttonName}`); }, 300); });
    
    // [Title, Theme & Other Minor Functions - Largely Unchanged]
    function saveTitleConfig() { localStorage.setItem('titleConfig', JSON.stringify({ title: document.getElementById('title').textContent, subtitle: document.getElementById('subtitle').textContent })); }
    function loadTitleConfig() { const d = localStorage.getItem('titleConfig'); if(d) { const {title, subtitle} = JSON.parse(d); document.getElementById('title').textContent = title; document.getElementById('subtitle').textContent = subtitle; } }
    document.getElementById('title').addEventListener('click', () => { if(isManagementMode) return; const n = prompt('请输入新标题：', document.getElementById('title').textContent); if (n?.trim()) { document.getElementById('title').textContent = n.trim(); saveTitleConfig(); } });
    document.getElementById('subtitle').addEventListener('click', () => { if(isManagementMode) return; const n = prompt('请输入新描述：', document.getElementById('subtitle').textContent); if (n !== null) { document.getElementById('subtitle').textContent = n.trim(); saveTitleConfig(); } });
    function initTheme() { const t=localStorage.getItem('theme'); if (t==='dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark-mode'); fabMainBtn.textContent = '🌙'; } else { fabMainBtn.textContent = '🌞'; } }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); const i=document.body.classList.contains('dark-mode'); fabMainBtn.textContent=i?'🌙':'🌞'; localStorage.setItem('theme', i?'dark':'light'); };
    
    // [CORE FUNCTION: Jellyfish Palette System]
    const colorModal = {
        pickerD1: document.getElementById('dayColor1Picker'), hexD1: document.getElementById('dayColor1Hex'),
        pickerD2: document.getElementById('dayColor2Picker'), hexD2: document.getElementById('dayColor2Hex'),
        pickerN1: document.getElementById('nightColor1Picker'), hexN1: document.getElementById('nightColor1Hex'),
        pickerN2: document.getElementById('nightColor2Picker'), hexN2: document.getElementById('nightColor2Hex'),
        presetName: document.getElementById('presetNameInput'), presetSelector: document.getElementById('presetSelector'),
        saveBtn: document.getElementById('savePresetBtn'), updateBtn: document.getElementById('updatePresetBtn'), deleteBtn: document.getElementById('deletePresetBtn'),
        randomToggle: document.getElementById('randomPaletteToggle')
    };
    let colorPresets = [], randomPaletteEnabled = false;
    const root = document.documentElement;

    function applyColors(colors) {
        Object.entries(colors).forEach(([key, value]) => {
            const cssVar = `--${key.replace('d', 'day-color').replace('n', 'night-color')}`;
            root.style.setProperty(cssVar, value);
            localStorage.setItem(key.replace('d', 'dayColor').replace('n', 'nightColor'), value);
        });
        updateColorPickersUI();
    }
    function updateColorPickersUI() {
        const colors = getCurrentColors();
        colorModal.pickerD1.value = colorModal.hexD1.value = colors.d1;
        colorModal.pickerD2.value = colorModal.hexD2.value = colors.d2;
        colorModal.pickerN1.value = colorModal.hexN1.value = colors.n1;
        colorModal.pickerN2.value = colorModal.hexN2.value = colors.n2;
    }
    function getCurrentColors() {
        return {
            d1: localStorage.getItem('dayColor1') || getComputedStyle(root).getPropertyValue('--day-color1').trim(),
            d2: localStorage.getItem('dayColor2') || getComputedStyle(root).getPropertyValue('--day-color2').trim(),
            n1: localStorage.getItem('nightColor1') || getComputedStyle(root).getPropertyValue('--night-color1').trim(),
            n2: localStorage.getItem('nightColor2') || getComputedStyle(root).getPropertyValue('--night-color2').trim(),
        };
    }
    function setupColorSync(picker, hexInput, key) {
        picker.addEventListener('input', () => { hexInput.value = picker.value; applyColors({ [key]: picker.value }); });
        hexInput.addEventListener('input', () => { if (/^#[0-9A-F]{6}$/i.test(hexInput.value)) { picker.value = hexInput.value; applyColors({ [key]: hexInput.value }); } });
    }
    function loadColorState() {
        colorPresets = JSON.parse(localStorage.getItem('colorPresets') || '[]');
        randomPaletteEnabled = localStorage.getItem('randomPaletteEnabled') === 'true';
        colorModal.randomToggle.checked = randomPaletteEnabled;
        if (randomPaletteEnabled && colorPresets.length > 0) {
            const randomPreset = colorPresets[Math.floor(Math.random() * colorPresets.length)];
            applyColors(randomPreset.colors);
        } else {
            applyColors(getCurrentColors());
        }
        populatePresetDropdown();
    }
    function saveColorPresets() { localStorage.setItem('colorPresets', JSON.stringify(colorPresets)); }
    function populatePresetDropdown() {
        colorModal.presetSelector.innerHTML = '<option value="">选择一个预设...</option>';
        colorPresets.forEach((p, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = p.name; colorModal.presetSelector.appendChild(opt); });
    }
    colorModal.saveBtn.addEventListener('click', () => {
        const name = colorModal.presetName.value.trim(); if (!name) { alert('请输入预设名称'); return; }
        if (colorPresets.some(p => p.name === name)) { alert('该预设名称已存在'); return; }
        colorPresets.push({ name, colors: getCurrentColors() });
        saveColorPresets(); populatePresetDropdown();
        colorModal.presetSelector.value = colorPresets.length - 1;
        colorModal.presetName.value = ''; alert('预设已保存');
    });
    colorModal.updateBtn.addEventListener('click', () => {
        const index = colorModal.presetSelector.value; if (index === '') { alert('请先选择一个预设'); return; }
        const name = colorModal.presetName.value.trim() || colorPresets[index].name;
        colorPresets[index] = { name, colors: getCurrentColors() };
        saveColorPresets(); populatePresetDropdown();
        colorModal.presetSelector.value = index; alert('预设已更新');
    });
    colorModal.deleteBtn.addEventListener('click', () => {
        const index = colorModal.presetSelector.value; if (index === '') { alert('请先选择一个预设'); return; }
        if (!confirm(`确定要删除预设 "${colorPresets[index].name}" 吗？`)) return;
        colorPresets.splice(index, 1);
        saveColorPresets(); populatePresetDropdown(); alert('预设已删除');
    });
    colorModal.presetSelector.addEventListener('change', () => {
        const index = colorModal.presetSelector.value; if (index === '') return;
        applyColors(colorPresets[index].colors);
        colorModal.presetName.value = colorPresets[index].name;
    });
    colorModal.randomToggle.addEventListener('change', () => {
        randomPaletteEnabled = colorModal.randomToggle.checked;
        localStorage.setItem('randomPaletteEnabled', randomPaletteEnabled);
    });

    // [Modals & File Sync - Unchanged Logic, only modal trigger adjustments]
    // The rest of your functions (file sync, other modals, add nav) remain here without changes in their internal logic.
    const syncModalElements={buttonSelector:document.getElementById("buttonSelector"),fileList:document.getElementById("fileList"),fileListStatus:document.getElementById("fileListStatus"),fileUploader:document.getElementById("fileUploader"),fileNameInput:document.getElementById("fileNameInput"),uploadBtn:document.getElementById("uploadBtn"),githubRepoInput:document.getElementById("githubRepoInput"),githubTokenInput:document.getElementById("githubTokenInput"),saveSettingsBtn:document.getElementById("saveSettingsBtn")};function setupModals(){document.querySelectorAll(".close-btn").forEach(e=>e.addEventListener("click",()=>{document.getElementById(e.dataset.modalId).classList.remove("show")})),document.querySelectorAll(".modal-overlay").forEach(e=>e.addEventListener("click",t=>e===t.target&&e.classList.remove("show"))),document.getElementById("syncBtn").addEventListener("click",()=>{document.getElementById("syncModal").classList.add("show"),populateButtonSelector(),fetchFilesForSelectedButton(),toggleFabMenu(!1)}),document.getElementById("settingsBtn").addEventListener("click",()=>{GITHUB_CONFIG.owner&&GITHUB_CONFIG.repo&&(syncModalElements.githubRepoInput.value=`${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`),syncModalElements.githubTokenInput.value=GITHUB_CONFIG.token||"",document.getElementById("settingsModal").classList.add("show")}),document.getElementById("addNavBtn").addEventListener("click",()=>{document.getElementById("addNavModal").classList.add("show"),toggleFabMenu(!1)}),document.getElementById("colorBtn").addEventListener("click",()=>{document.getElementById("colorPaletteModal").classList.add("show"),updateColorPickersUI(),toggleFabMenu(!1)})}
    function saveGithubConfig(e){localStorage.setItem("githubConfig",JSON.stringify(e)),GITHUB_CONFIG=e}function loadGithubConfig(){const e=localStorage.getItem("githubConfig");e&&(GITHUB_CONFIG=JSON.parse(e))}function checkConfig(e=!0){return!GITHUB_CONFIG.owner||!GITHUB_CONFIG.repo||!GITHUB_CONFIG.token?(e&&alert("请先配置GitHub仓库信息。\n(打开菜单 -> 数据云盘 -> 标题旁⚙️)"),!1):!0}
    async function loadConfig() { navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889; width: 100%;">正在从云端加载配置...</p>'; const config = await fetchConfigFromGithub(); navContainer.innerHTML = ''; if (config.length === 0) { navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889; width: 100%;">配置为空，请点击右下角 "+" 添加您的第一个导航按钮。</p>'; } else { config.forEach(item => addNewButtonToDOM(item.text, item.href)); } }
    async function deleteGithubFolder(folderPath) { if (!checkConfig(true)) return false; const contentsUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${folderPath}`; try { const contentsResponse = await fetch(contentsUrl, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } }); if (!contentsResponse.ok) throw new Error(`Could not list folder contents: ${contentsResponse.statusText}`); const files = await contentsResponse.json(); const deletePromises = files.map(file => { return fetch(file.url, { method: 'DELETE', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify({ message: `Delete file: ${file.path}`, sha: file.sha, branch: 'main' }) }); }); await Promise.all(deletePromises); console.log(`Folder "${folderPath}" deleted.`); return true; } catch (error) { console.error(`Failed to delete folder "${folderPath}":`, error); return false; } }
    syncModalElements.saveSettingsBtn.addEventListener("click",async()=>{const[e,t]=syncModalElements.githubRepoInput.value.trim().split("/").map(e=>e.trim()),n=syncModalElements.githubTokenInput.value.trim();e&&t&&n?(saveGithubConfig({owner:e,repo:t,token:n,branch:"main"}),alert("配置已保存！请刷新页面以加载云端配置。"),document.getElementById("settingsModal").classList.remove("show"),await loadConfig()):alert("请填写完整信息。")});function populateButtonSelector(){const e=syncModalElements.buttonSelector.value;syncModalElements.buttonSelector.innerHTML="",document.querySelectorAll(".nav-btn").forEach(t=>{const n=t.textContent.replace("×","").trim(),o=document.createElement("option");o.value=o.textContent=n,syncModalElements.buttonSelector.appendChild(o)}),Array.from(syncModalElements.buttonSelector.options).some(t=>t.value===e)&&(syncModalElements.buttonSelector.value=e)}
    syncModalElements.buttonSelector.addEventListener("change",fetchFilesForSelectedButton),syncModalElements.fileUploader.addEventListener("change",()=>{syncModalElements.fileUploader.files.length>0&&(syncModalElements.fileNameInput.value=syncModalElements.fileUploader.files[0].name)});async function fetchFilesForSelectedButton(){const e=syncModalElements.buttonSelector.value;if(syncModalElements.fileList.innerHTML="",syncModalElements.fileListStatus.style.display="block",!e)return void(syncModalElements.fileListStatus.textContent="请选择一个分类");if(!checkConfig(!0))return void(syncModalElements.fileListStatus.innerHTML="尚未配置GitHub信息<br>请点击标题旁 ⚙️ 进行设置");syncModalElements.fileListStatus.textContent="正在加载...";const t=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${SYNC_FOLDER}/${e}`;try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`},cache:"no-cache"});if(404===n.status)return void(syncModalElements.fileListStatus.textContent="该分类下暂无文件");if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.json();if(0===o.length)syncModalElements.fileListStatus.textContent="该分类下暂无文件";else{syncModalElements.fileListStatus.textContent="正在获取文件信息...";const l=await Promise.all(o.map(async e=>({...e,commitDate:await getLatestCommitDate(e.path)})));l.sort((e,t)=>new Date(t.commitDate)-new Date(e.commitDate)),syncModalElements.fileList.innerHTML="",syncModalElements.fileListStatus.style.display="none",l.forEach(e=>{const t=document.createElement("li"),n=document.createElement("div");n.className="file-info",n.dataset.downloadUrl=e.download_url,n.dataset.fileName=e.name;const o=document.createElement("span");o.className="file-name",o.textContent=e.name;const l=document.createElement("span");l.className="file-timestamp",l.textContent=(new Date(e.commitDate)).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),n.append(o,l);const a=document.createElement("button");a.className="delete-btn",a.innerHTML="&times;",a.title="删除文件",t.append(n,a),syncModalElements.fileList.appendChild(t),n.addEventListener("click",t=>forceDownload(t.currentTarget.dataset.downloadUrl,t.currentTarget.dataset.fileName,n)),a.addEventListener("click",()=>deleteFile(e.path,e.sha,t))})}}catch(n){console.error("获取文件列表失败:",n),syncModalElements.fileListStatus.textContent="加载失败，请检查网络或配置。"}}
    async function getLatestCommitDate(e){const t=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(e)}&page=1&per_page=1`;try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`}});if(!n.ok)return(new Date(0)).toISOString();const o=await n.json();return o[0]?.commit.committer.date||(new Date(0)).toISOString()}catch(n){return console.error(`获取提交日期失败 for ${e}:`,n),(new Date(0)).toISOString()}}async function deleteFile(e,t,n){if(!confirm(`确定要永久删除文件 "${e.split("/").pop()}" 吗？此操作不可恢复。`))return;n.style.opacity="0.5";const o=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${e}`;try{const l=await fetch(o,{method:"DELETE",headers:{"Authorization":`token ${GITHUB_CONFIG.token}`},body:JSON.stringify({message:`Delete file: ${e}`,sha:t,branch:"main"})});if(!l.ok)throw new Error(`删除失败: ${(await l.json()).message}`);n.remove(),0===syncModalElements.fileList.children.length&&(syncModalElements.fileListStatus.textContent="该分类下暂无文件",syncModalElements.fileListStatus.style.display="block")}catch(l){console.error("删除文件失败:",l),alert(`删除文件失败: ${l.message}`),n.style.opacity="1"}}async function forceDownload(e,t,n){const o=n.querySelector(".file-name").textContent;n.querySelector(".file-name").textContent="准备下载中...",n.style.pointerEvents="none";try{const l=await fetch(e);if(!l.ok)throw new Error(`下载请求失败: ${l.statusText}`);const a=await l.blob(),c=document.createElement("a");c.href=window.URL.createObjectURL(a),c.download=t,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(c.href)}catch(l){console.error("Download error:",l),alert(`下载文件时出错: ${l.message}`)}finally{n.querySelector(".file-name").textContent=o,n.style.pointerEvents="auto"}}
    syncModalElements.uploadBtn.addEventListener("click",async()=>{if(!checkConfig())return;const e=syncModalElements.buttonSelector.value,t=syncModalElements.fileUploader.files[0];let n=syncModalElements.fileNameInput.value.trim()||t&&t.name;if(!e||!t||!n)return void alert("请选择分类、文件，并确保文件名不为空。");syncModalElements.uploadBtn.disabled=!0,syncModalElements.uploadBtn.textContent="上传中...";try{const o=await new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result.split(",")[1]),n.onerror=t,n.readAsDataURL(file)});const l=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${SYNC_FOLDER}/${e}/${n}`,a=await fetch(l,{method:"PUT",headers:{"Authorization":`token ${GITHUB_CONFIG.token}`},body:JSON.stringify({message:`Upload ${n}`,content:o,branch:"main"})});if(!a.ok)throw new Error(`上传失败: ${a.statusText}`);alert("上传成功！"),syncModalElements.fileUploader.value="",syncModalElements.fileNameInput.value="",fetchFilesForSelectedButton()}catch(o){console.error("上传失败:",o),alert(`上传失败: ${o.message}`)}finally{syncModalElements.uploadBtn.disabled=!1,syncModalElements.uploadBtn.textContent="上传文件"}});const addNavModalElements={typeLink:document.getElementById("type-link"),typeUpload:document.getElementById("type-upload"),linkSection:document.getElementById("link-section"),uploadSection:document.getElementById("upload-section"),nameInput:document.getElementById("newButtonNameInput"),urlInput:document.getElementById("newButtonUrlInput"),folderPickerBtn:document.getElementById("folderPickerBtn"),folderStatus:document.getElementById("folder-picker-status"),createBtn:document.getElementById("createNavBtn"),uploadStatus:document.getElementById("upload-status")};function addNewButtonToDOM(e,t){navContainer.querySelector("#loading-status")&&(navContainer.innerHTML="");const n=document.createElement("button");n.className="nav-btn",n.textContent=e,n.dataset.href=t,navContainer.appendChild(n),attachButtonListeners(n),isManagementMode&&(()=>{const e=document.createElement("span");e.className="delete-icon",e.innerHTML="&times;",e.title="删除此按钮",n.appendChild(e)})()}
    addNavModalElements.typeLink.addEventListener("change",()=>{addNavModalElements.linkSection.style.display="flex",addNavModalElements.uploadSection.style.display="none"}),addNavModalElements.typeUpload.addEventListener("change",()=>{addNavModalElements.linkSection.style.display="none",addNavModalElements.uploadSection.style.display="flex"}),addNavModalElements.folderPickerBtn.addEventListener("click",async()=>{if(!window.showDirectoryPicker)return void alert("您的浏览器不支持文件夹选择功能。");try{localDirectoryHandle=await window.showDirectoryPicker(),addNavModalElements.folderStatus.textContent=`已选择: ${localDirectoryHandle.name}`}catch(e){console.log("用户取消了文件夹选择")}});function fileToBase64(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result.split(",")[1]),o.onerror=n,o.readAsDataURL(e)})}async function getFilesInDirectory(e,t=""){const n=[];for await(const o of e.values()){const l=t?`${t}/${o.name}`:o.name;if("file"===o.kind){const a=await o.getFile();n.push({file:a,path:l})}else"directory"===o.kind&&n.push(...await getFilesInDirectory(o,l))}return n}
    addNavModalElements.createBtn.addEventListener("click",async()=>{const e=addNavModalElements.nameInput.value.trim();if(!e)return void alert("请输入按钮名称。");const t=document.querySelector('input[name="nav-type"]:checked').value;addNavModalElements.createBtn.disabled=!0,addNavModalElements.createBtn.textContent="处理中...";try{let n;if("link"===t){const o=addNavModalElements.urlInput.value.trim();if(!o)return void alert("请输入网址链接。");n={text:e,href:o}}else if("upload"===t){if(!checkConfig())return;if(!localDirectoryHandle)return void alert("请选择一个项目文件夹。");const l=await getFilesInDirectory(localDirectoryHandle),a=e.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g,"").replace(/\s+/g,"-")||`project-${Date.now()}`;if(!l.some(e=>e.path.endsWith("index.html")))return void alert("错误：文件夹中必须包含 index.html 文件。");for(let c=0;c<l.length;c++){const{file:r,path:s}=l[c];addNavModalElements.uploadStatus.textContent=`上传中 ${c+1}/${l.length}: ${s}`;const d=await fileToBase64(r),u=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${a}/${s}`,p=await fetch(u,{method:"PUT",headers:{"Authorization":`token ${GITHUB_CONFIG.token}`},body:JSON.stringify({message:`Create ${s}`,content:d,branch:GITHUB_CONFIG.branch||"main"})});if(!p.ok)throw new Error(`上传 ${s} 失败: ${p.statusText}`)}n={text:e,href:`${a}/index.html`},alert("项目上传并发布成功！")}addNewButtonToDOM(n.text,n.href),await saveCurrentConfig(`Add button: ${n.text}`),document.getElementById("addNavModal").classList.remove("show")}catch(o){console.error("创建导航失败:",o),alert(`操作失败: ${o.message}`),addNavModalElements.uploadStatus.textContent="操作失败!"}finally{addNavModalElements.createBtn.disabled=!1,addNavModalElements.createBtn.textContent="创建新导航",addNavModalElements.nameInput.value="",addNavModalElements.urlInput.value="",addNavModalElements.folderStatus.textContent="",addNavModalElements.uploadStatus.textContent="",localDirectoryHandle=null}});

    // [页面加载初始化]
    window.addEventListener('load', async () => {
        loadTitleConfig();
        initTheme();
        loadColorState();
        loadGithubConfig();
        await loadConfig();
        setupModals();
        setupColorSync(colorModal.pickerD1, colorModal.hexD1, 'd1');
        setupColorSync(colorModal.pickerD2, colorModal.hexD2, 'd2');
        setupColorSync(colorModal.pickerN1, colorModal.hexN1, 'n1');
        setupColorSync(colorModal.pickerN2, colorModal.hexN2, 'n2');
    });
    </script>
</body>
</html>
