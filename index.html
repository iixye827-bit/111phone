<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- PWA & Mobile App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16213e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>JellyfishCenter</title>
    <style>
        /* [CSS - V8.4.0 "Guided Setup & UX Refinements"] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif; }
        :root {
            --day-color1: #f5f7fa; --day-color2: #e4eaf5;
            --night-color1: #1f2a40; --night-color2: #16213e;
            --hold-border: #5B99E2; --text-day: #2d3748; --text-night: #e0e6f0;
            --bg-day-element: linear-gradient(135deg, var(--day-color2), var(--day-color1));
            --bg-night-element: linear-gradient(135deg, var(--night-color2), var(--night-color1));
            --shadow-light-day: rgba(255, 255, 255, 0.9); --shadow-dark-day: rgba(174, 190, 212, 0.4);
            --shadow-light-night: rgba(40, 52, 79, 0.9); --shadow-dark-night: rgba(0, 0, 0, 0.3);
        }
        body { min-height: 100vh; background: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%); padding: 20px; display: flex; flex-direction: column; align-items: center; transition: background 0.5s ease; touch-action: manipulation; overflow-x: hidden; }
        body.dark-mode { background: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%); --hold-border: #63b3ed; color: var(--text-night); }
        .title-card { width: 100%; max-width: 800px; padding: 40px 20px; margin: 20px 0; border-radius: 16px; box-shadow: 12px 12px 24px var(--shadow-dark-day), -12px -12px 24px var(--shadow-light-day); background: var(--bg-day-element); backdrop-filter: blur(8px); text-align: center; transition: all 0.5s ease; }
        body.dark-mode .title-card { box-shadow: 12px 12px 24px var(--shadow-dark-night), -12px -12px 24px var(--shadow-light-night); background: var(--bg-night-element); }
        .editable-title, .editable-subtitle { opacity: 0; transition: opacity 0.5s ease; } /* FOUC Fix */
        .editable-title { font-size: 36px; font-weight: 700; color: var(--text-day); margin-bottom: 20px; cursor: pointer; padding: 6px 12px; border-radius: 8px; display: block; width: fit-content; margin: 0 auto 20px auto; user-select: none; }
        body.dark-mode .editable-title { color: var(--text-night); }
        .editable-title:hover { background-color: rgba(255, 255, 255, 0.8); } body.dark-mode .editable-title:hover { background-color: rgba(50, 55, 75, 0.8); }
        .editable-subtitle { font-size: 16px; color: #5a6778; cursor: pointer; padding: 4px 8px; border-radius: 6px; display: block; width: fit-content; margin: 0 auto; line-height: 1.5; user-select: none; }
        body.dark-mode .editable-subtitle { color: #c0c6cc; }
        .editable-subtitle:hover { background-color: rgba(255, 255, 255, 0.8); color: var(--text-day); } body.dark-mode .editable-subtitle:hover { background-color: rgba(50, 55, 75, 0.8); color: var(--text-night); }
        .nav-container { width: 100%; max-width: 1200px; margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; padding: 20px; position: relative; z-index: 10; }
        .nav-btn { position: relative; padding: 22px 16px; border: none; border-radius: 14px; box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day); background: var(--bg-day-element); backdrop-filter: blur(8px); font-size: 17px; font-weight: 600; color: var(--text-day); cursor: pointer; transition: all 0.3s ease; text-align: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .nav-btn.hold { border: 2px solid var(--hold-border); transform: scale(1.02); z-index: 5; box-shadow: 8px 8px 16px rgba(174, 190, 212, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.8), 0 0 0 2px rgba(91, 153, 226, 0.3); }
        body.dark-mode .nav-btn { box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        body.dark-mode .nav-btn.hold { box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.4), -8px -8px 16px rgba(40, 52, 79, 0.8), 0 0 0 2px rgba(99, 179, 237, 0.3); }
        .nav-btn:hover { transform: translateY(-3px); filter: brightness(1.05); }
        .nav-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); transform: translateY(0); }
        body.dark-mode .nav-btn:active { box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.25), inset -6px -6px 12px rgba(40, 52, 79, 0.8); }
        .delete-icon { display: none; position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background-color: #f56565; color: white; border-radius: 50%; border: 2px solid white; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); z-index: 99; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .page-overlay.show { opacity: 1; pointer-events: auto; }
        .page-overlay.management-overlay { background: transparent; backdrop-filter: none; z-index: 5; }
        .management-active .nav-btn { cursor: move; animation: wiggle 0.2s ease-in-out infinite alternate; pointer-events: auto !important; }
        .management-active .nav-btn > .delete-icon { display: block; }
        @keyframes wiggle { from { transform: rotate(-0.5deg); } to { transform: rotate(0.5deg); } }
        .fab-container { position: fixed; right: 30px; bottom: 30px; z-index: 100; }
        .fab-main, .fab-drawer-item { position: relative; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); background: var(--bg-day-element); color: var(--text-day); font-size: 22px; display: flex; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        body.dark-mode .fab-main, body.dark-mode .fab-drawer-item { box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); background: var(--bg-night-element); color: var(--text-night); }
        .fab-main:active, .fab-drawer-item:active { transform: scale(0.95); }
        .fab-container.active .fab-main { transform: rotate(45deg); }
        .fab-drawer { position: absolute; bottom: 65px; left: 0; display: flex; flex-direction: column; gap: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; }
        .fab-container.active .fab-drawer { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #sync-status-indicator { position: absolute; right: 5px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background-color: transparent; transition: all 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        #sync-status-indicator.synced { background-color: #28a745; } #sync-status-indicator.syncing { background-color: #ffc107; animation: pulse 1.5s infinite; } #sync-status-indicator.error { background-color: #dc3545; animation: none; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}.modal-overlay.show{display:flex;opacity:1}.modal-content{width:90%;background:var(--bg-day-element);color:var(--text-day);border-radius:16px;box-shadow:12px 12px 24px var(--shadow-dark-day),-12px -12px 24px var(--shadow-light-day);padding:12px;transition:transform .3s ease,background .5s ease,box-shadow .5s ease;transform:scale(.95);display:flex;flex-direction:column;max-height:90vh}.modal-overlay.show .modal-content{transform:scale(1)}body.dark-mode .modal-content{background:var(--bg-night-element);color:var(--text-night);box-shadow:12px 12px 24px var(--shadow-dark-night),-12px -12px 24px var(--shadow-light-night)}.modal-header{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:600;margin-bottom:20px;flex-shrink:0; padding: 0 3px;}.modal-title-group{display:flex;align-items:center;gap:8px}.modal-header .close-btn,.modal-header .settings-btn{cursor:pointer;border:none;background:transparent;color:inherit;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.modal-header .close-btn{font-size:24px;font-weight:bold;width:36px;height:36px}.modal-header .settings-btn{font-size:20px;width:32px;height:32px}.modal-header .close-btn:hover,.modal-header .settings-btn:hover{background:rgba(0,0,0,0.05)}body.dark-mode .modal-header .close-btn:hover,body.dark-mode .modal-header .settings-btn:hover{background:rgba(255,255,255,0.08)}
        .modal-body { overflow-y: auto; flex-grow: 1; display:flex; flex-direction:column; gap: 15px; margin-right: -5px; padding-right: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .modal-body > * { margin-left: 3px; margin-right: 3px; width: calc(100% - 6px); }
        .modal-body::-webkit-scrollbar { width: 0; background: transparent; }
        .modal-input,.modal-select{padding:12px 15px;border:none;border-radius:10px;font-size:16px;background:var(--bg-day-element);color:var(--text-day);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day);transition:all .3s ease;caret-color:var(--hold-border)}body.dark-mode .modal-input,body.dark-mode .modal-select{background:var(--bg-night-element);color:var(--text-night);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-input:focus,.modal-select:focus{outline:none;box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day),0 0 0 2px var(--hold-border)}body.dark-mode .modal-input:focus,body.dark-mode .modal-select:focus{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night),0 0 0 2px var(--hold-border)}
        .modal-button{padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:var(--hold-border);background:var(--bg-day-element);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .2s ease}body.dark-mode .modal-button{color:var(--hold-border);background:var(--bg-night-element);box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}.modal-button:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode .modal-button:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}.modal-button:disabled{color:#9db2c2;cursor:not-allowed;box-shadow:none;}
        #nukeDataBtn { background: #e53e3e !important; color: white !important; box-shadow: 4px 4px 8px rgba(229, 62, 62, 0.5), -4px -4px 8px rgba(255, 255, 255, 0.9) !important; }
        #nukeDataBtn:active { background: #c53030 !important; box-shadow: inset 4px 4px 8px rgba(155, 37, 37, 0.7) !important; }
        #settingsModal .modal-body .nuke-section { margin: 15px 0 10px; border-top: 1px solid rgba(128,128,128,0.3); padding-top: 15px; display: flex; justify-content: center; }
        #syncErrorModal .modal-content { max-width: 450px; } #sync-error-message { padding: 12px; border-radius: 8px; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.2); font-family: monospace; font-size: 14px; word-wrap: break-word; user-select: text; } body.dark-mode #sync-error-message { background: rgba(252, 129, 129, 0.1); border-color: rgba(252, 129, 129, 0.2); }
        #colorPaletteModal .modal-content, #helpModal .modal-content { max-width: 500px; } #colorPaletteModal .modal-body { gap: 20px; }
        .color-picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .color-picker-group { display: flex; flex-direction: column; gap: 8px; }
        .color-picker-group label { font-size: 14px; color: #5a6778; } body.dark-mode .color-picker-group label { color: #c0c6cc; }
        .color-input-wrapper { display: flex; align-items: center; border-radius: 10px; padding: 5px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); } body.dark-mode .color-input-wrapper { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        input[type="color"] { width: 36px; height: 30px; border: none; background: transparent; cursor: pointer; -webkit-appearance: none; padding: 0; flex-shrink: 0; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: none; }
        .hex-display { flex-grow: 1; text-align: right; padding: 0 10px; font-family: monospace; font-size: 16px; color: #889; }
        .preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .preview-box { height: 40px; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .preview-box::before { content: attr(data-label); } #dayPreview { border: 2px solid var(--bg-day-element); color: var(--text-day); } body.dark-mode #dayPreview { border-color: rgba(255,255,255,0.1); }
        #nightPreview { border: 2px solid var(--bg-night-element); color: var(--text-night); } body.dark-mode #nightPreview { border-color: rgba(255,255,255,0.2); }
        .preset-manager { border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        body.dark-mode .preset-manager { border-color: rgba(255,255,255,0.1); } .preset-row { display: flex; align-items: center; gap: 10px; }
        .preset-row .modal-input, .preset-row .modal-select { flex-grow: 1; }
        .preset-row .modal-button { width: auto; padding: 12px 15px; flex-shrink: 0; font-size: 14px; }
        .preset-row .modal-button.save { color: #28a745; } .preset-row .modal-button.delete { color: #dc3545; }
        .random-toggle-section { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 12px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .random-toggle-section { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; } .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; } .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hold-border); } input:checked + .slider:before { transform: translateX(18px); }
        #file-list-container{flex-grow:1;overflow-y:auto;border-radius:10px;padding:5px;margin-top:10px;background:var(--bg-day-element);box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}body.dark-mode #file-list-container{background:var(--bg-night-element);box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}#file-list-container ul{list-style:none;padding:5px}#file-list-container li{padding:8px 15px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:background .2s;gap:10px}#file-list-container li:hover{background-color:rgba(0,0,0,0.05)}body.dark-mode #file-list-container li:hover{background-color:rgba(255,255,255,0.08)}#file-list-status{text-align:center;color:#889;padding:30px 10px}.file-info{flex-grow:1;cursor:pointer;min-width:0}.file-name{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:16px}.file-timestamp{font-size:12px;font-weight:300;color:#9A86A4}.delete-btn{background:transparent;border:none;cursor:pointer;padding:0;flex-shrink:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s,color .2s;color:#bbb;font-size:22px;font-weight:bold;line-height:1}.delete-btn:hover{background:#f0f0f0;color:#e53e3e}body.dark-mode .delete-btn{color:#889}body.dark-mode .delete-btn:hover{background:rgba(255,255,255,0.1);color:#fc8181}
        #settingsModal .modal-content,#addNavModal .modal-content, #syncModal .modal-content {max-width:400px}
        #settingsModal .modal-body .form-section,#addNavModal .modal-body .form-section{display:flex;flex-direction:column;gap:8px}#settingsModal label,#addNavModal label{font-size:14px;color:#5a6778}body.dark-mode #settingsModal label,body.dark-mode #addNavModal label{color:#c0c6cc}
        .segmented-control { position: relative; display: flex; border-radius: 12px; padding: 5px; background:var(--bg-day-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); }
        body.dark-mode .segmented-control { background:var(--bg-night-element); box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night); }
        .segmented-control label { position: relative; z-index: 1; flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: color .3s ease; font-weight: 600; color: #889; font-size: 14px; }
        .segmented-control .slider-indicator { position: absolute; top: 5px; left: 5px; bottom: 5px; background: var(--bg-day-element); box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day); border-radius: 8px; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 0; }
        body.dark-mode .segmented-control .slider-indicator { background: var(--bg-night-element); box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night); }
        #addNavModal input[type="radio"]:checked + label, #helpModal input[type="radio"]:checked + label { color: var(--hold-border); }
        #type-upload:checked ~ .slider-indicator { transform: translateX(100%); }
        .segmented-control.two-segments .slider-indicator { width: calc(50% - 5px); }
        .segmented-control.three-segments .slider-indicator { width: calc(33.33% - 4px); }
        #addNavModal .status-text{text-align:center;font-size:14px;color:#889;min-height:20px} #addNavModal .modal-header { gap: 10px; } #addNavModal .modal-title-group { flex-grow: 1; }
        .header-toggle-group { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: normal; color: #5a6778; } body.dark-mode .header-toggle-group { color: #c0c6cc; }
        .file-select-wrapper { display: flex; align-items: center; gap: 10px; width: 100%; } .file-select-wrapper .modal-button { flex-shrink: 0; width: auto; padding: 10px 15px; font-size: 14px; }
        .file-select-wrapper .status-text { flex-grow: 1; font-size: 14px; color: #889; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #syncModal .file-upload-section { display: flex; flex-direction: column; gap: 10px; } #syncModal input[type="file"] { display: none; }
        #syncModal .progress-container { display: none; height: 12px; background:var(--bg-day-element); border-radius: 6px; box-shadow: inset 2px 2px 4px var(--shadow-dark-day), inset -2px -2px 4px var(--shadow-light-day); padding: 2px; } body.dark-mode #syncModal .progress-container { box-shadow: inset 2px 2px 4px var(--shadow-dark-night), inset -2px -2px 4px var(--shadow-light-night); }
        #syncModal .progress-bar { width: 0%; height: 100%; border-radius: 4px; background-color: #707899; transition: width 0.2s linear; }
        #helpModal .modal-body { gap: 0; padding-top: 15px; } #helpModal .modal-body > input[name="help-tab"] { display: none; } #help-tab-2:checked ~ .segmented-control .slider-indicator { transform: translateX(100%); } #help-tab-3:checked ~ .segmented-control .slider-indicator { transform: translateX(200%); }
        .help-page-content { display: none; padding: 15px 5px 0 5px; overflow-x: hidden; }
        #help-tab-1:checked ~ .help-content-wrapper > #help-page-1, #help-tab-2:checked ~ .help-content-wrapper > #help-page-2, #help-tab-3:checked ~ .help-content-wrapper > #help-page-3 { display: block; }
        .help-page-content h3 { font-size: 1.3em; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid rgba(128,128,128,0.3); } .help-page-content h4 { font-size: 1.1em; margin: 18px 0 8px 0; }
        .help-page-content p, .help-page-content li, .help-page-content a { line-height: 1.7; color: #4a5568; margin-bottom: 8px; word-wrap: break-word; }
        body.dark-mode .help-page-content p, body.dark-mode .help-page-content li, body.dark-mode .help-page-content a { color: #a0aec0; }
        .help-page-content ul, .help-page-content ol { padding-left: 25px; } .help-page-content ol li { margin-bottom: 12px; }
        .help-page-content strong { color: var(--hold-border); font-weight: 600; } .help-page-content code { background-color: rgba(128,128,128,0.15); padding: 2px 5px; border-radius: 4px; font-family: monospace; word-wrap: break-word; }
        .help-page-content a { color: var(--hold-border); text-decoration: none; font-weight: 600; } .help-page-content a:hover { text-decoration: underline; }
        .help-page-content .warning { background-color: rgba(229, 62, 62, 0.1); border-left: 4px solid #e53e3e; padding: 10px 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
        .help-page-content .important-note { background-color: rgba(91, 153, 226, 0.1); border-left: 4px solid var(--hold-border); padding: 10px 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
        /* == Iframe Modal & Confirmation Toast Styles == */
        .iframe-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .iframe-modal-overlay.active { transform: translateX(0); }
        .iframe-modal-content { width: 100%; height: 100%; background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: transform 0.3s ease-out; }
        .iframe-modal-content.dragging { transition: none; }
        .iframe-modal-content iframe { width: 100%; height: 100%; border: none; }
        .swipe-hint { position: fixed; left: 0; top: 50%; transform: translateY(-50%); display: flex; align-items: center; background: rgba(0,0,0,0.6); color: white; padding: 10px 15px 10px 10px; border-radius: 0 8px 8px 0; z-index: 2001; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        .swipe-hint.show { opacity: 1; }
        .swipe-hint .arrow { width: 16px; height: 16px; border-right: 3px solid white; border-bottom: 3px solid white; transform: rotate(-45deg); animation: hint-pulse 1.5s infinite; margin-right: 10px; }
        @keyframes hint-pulse { 0% { opacity: 0.3; } 50% { opacity: 1; transform: rotate(-45deg) scale(1.1); } 100% { opacity: 0.3; } }
        #gestureCaptureZone { position: fixed; top: 0; left: 0; width: 50px; height: 100%; z-index: 2002; }
        #returnConfirmationToast { position: fixed; top: 0; left: 50%; transform: translate(-50%, -120%); width: calc(100% - 30px); max-width: 400px; background: var(--bg-night-element); color: var(--text-night); padding: 12px 16px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2003; display: flex; justify-content: space-between; align-items: center; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; }
        #returnConfirmationToast.show { transform: translate(-50%, 0); }
        .toast-btn { background: transparent; border: none; color: white; font-size: 15px; font-weight: 600; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .toast-btn-confirm { background-color: rgba(99, 179, 237, 0.8); } .toast-btn-confirm:hover { background-color: rgba(99, 179, 237, 1); }
        .toast-btn-cancel { background-color: rgba(255, 255, 255, 0.2); } .toast-btn-cancel:hover { background-color: rgba(255, 255, 255, 0.3); }
        @media (max-width: 480px) { .editable-title { font-size: 28px; } .editable-subtitle { font-size: 14px; } .title-card { padding: 30px 15px; } .nav-container { grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px; } .nav-btn { padding: 18px 10px; font-size: 15px; } .fab-container { right: 20px; bottom: 20px; } .fab-main, .fab-drawer-item { width: 44px; height: 44px; font-size: 20px; } .fab-drawer { bottom: 55px; } .segmented-control label { font-size: 13px; padding: 8px 5px; } }
    </style>
    
    <!-- ========== [NEW] Memories Feature CSS ========== -->
    <style>
        #memoriesModal .modal-content {
            width: 100%;
            max-width: 100%;
            height: 100%;
            max-height: 100%;
            border-radius: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%);
        }
        body.dark-mode #memoriesModal .modal-content {
            background: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%);
        }
        #memoriesModal .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        #memoriesModal .page {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            position: absolute; top: 0; left: 0; opacity: 0;
            transform: scale(0.98); transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none; background: transparent;
        }
        #memoriesModal .page.active { opacity: 1; transform: scale(1); pointer-events: auto; z-index: 10; }
        #memoriesModal .page-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; flex-shrink: 0; position: relative;
        }
        #memoriesModal .page-header .title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-size: 20px; font-weight: 700;
        }
        #memoriesModal .header-btn {
            font-size: 16px; font-weight: 600; cursor: pointer; padding: 8px 12px;
            border-radius: 10px; transition: background-color 0.2s; border: none;
            background: transparent; color: inherit; z-index: 5;
        }
        #memoriesModal .header-btn:hover { background-color: rgba(0,0,0,0.05); }
        body.dark-mode #memoriesModal .header-btn:hover { background-color: rgba(255,255,255,0.1); }
        #memoriesModal .header-btn.back-btn { font-size: 24px; padding: 5px 10px; }
        #memoriesModal .header-btn.manage-btn, #memoriesModal .header-btn.wander-btn { color: var(--hold-border); }
        #memoriesModal .header-controls { display: flex; gap: 8px; }
        #memoriesModal .list-container {
            flex-grow: 1; overflow-y: auto; padding: 0 15px 80px 15px; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px; align-content: flex-start;
        }
        #memoriesModal .list-container.manage .folder-item .delete-icon,
        #memoriesModal .list-container.manage .album-item .delete-icon { display: flex; }
        #memoriesModal #hub-view .title { position: static; transform: none; font-size: 28px; margin-bottom: 40px; text-align: center; }
        #memoriesModal #hub-view-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 30px; }
        #memoriesModal .hub-btn {
            width: 80%; max-width: 300px; padding: 40px 20px; border: none; border-radius: 20px;
            box-shadow: 10px 10px 20px var(--shadow-dark-day), -10px -10px 20px var(--shadow-light-day);
            background: var(--bg-day-element); color: var(--text-day);
            font-size: 24px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        body.dark-mode #memoriesModal .hub-btn {
            box-shadow: 10px 10px 20px var(--shadow-dark-night), -10px -10px 20px var(--shadow-light-night);
            background: var(--bg-night-element); color: var(--text-night);
        }
        #memoriesModal .hub-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-day), inset -6px -6px 12px var(--shadow-light-day); }
        body.dark-mode #memoriesModal .hub-btn:active { box-shadow: inset 6px 6px 12px var(--shadow-dark-night), inset -6px -6px 12px var(--shadow-light-night); }
        #memoriesModal #notes-list-container { grid-template-columns: 1fr; }
        #memoriesModal .folder-item, #memoriesModal .note-item, #memoriesModal .album-item {
            position: relative; padding: 20px 15px; border: none; border-radius: 14px;
            box-shadow: 8px 8px 16px var(--shadow-dark-day), -8px -8px 16px var(--shadow-light-day);
            background: var(--bg-day-element); font-size: 16px; font-weight: 600; color: var(--text-day);
            cursor: pointer; transition: all 0.3s ease; user-select: none; -webkit-tap-highlight-color: transparent; text-align: left;
        }
        #memoriesModal .delete-icon {
            display: none; position: absolute; top: -8px; right: -8px; width: 28px; height: 28px;
            background-color: #f56565; color: white; border-radius: 50%; border: 2px solid white;
            font-size: 20px; font-weight: bold; line-height: 24px; text-align: center; cursor: pointer; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); align-items: center; justify-content: center;
        }
        body.dark-mode #memoriesModal .folder-item, body.dark-mode #memoriesModal .note-item, body.dark-mode #memoriesModal .album-item {
            box-shadow: 8px 8px 16px var(--shadow-dark-night), -8px -8px 16px var(--shadow-light-night);
            background: var(--bg-night-element); color: var(--text-night);
        }
        #memoriesModal .folder-item:active, #memoriesModal .note-item:active, #memoriesModal .album-item:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark-day), inset -4px -4px 8px var(--shadow-light-day); transform: translateY(0);
        }
        body.dark-mode #memoriesModal .folder-item:active, body.dark-mode #memoriesModal .note-item:active, body.dark-mode #memoriesModal .album-item:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark-night), inset -4px -4px 8px var(--shadow-light-night);
        }
        #memoriesModal .folder-icon { font-size: 24px; margin-bottom: 10px; }
        #memoriesModal .note-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #memoriesModal .note-preview { font-size: 14px; font-weight: normal; color: #6a7889; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        body.dark-mode #memoriesModal .note-preview { color: #a0aec0; }
        #memoriesModal .note-timestamp { font-size: 12px; font-weight: 300; color: #9A86A4; margin-top: 12px; }
        #memoriesModal .album-item { aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; }
        #memoriesModal .album-item .folder-icon { font-size: 32px; }
        #memoriesModal .album-info { font-size: 12px; color: #889; }
        #memoriesModal #photo-list-container { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        #memoriesModal .photo-item {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 12px;
            background-size: cover; background-position: center;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1), inset -2px -2px 4px rgba(255,255,255,0.7);
            cursor: pointer; transition: transform 0.2s ease;
        }
        #memoriesModal .photo-item:hover { transform: scale(1.05); }
        #photo-viewer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 5000; display: flex; flex-direction: column;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #photo-viewer-overlay.active { opacity: 1; pointer-events: auto; }
        #photo-viewer-overlay .viewer-header {
            display: flex; justify-content: flex-end; padding: 20px; color: white;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }
        #photo-viewer-overlay .viewer-btn {
            background: rgba(40,40,40,0.5); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer;
            transition: background-color 0.2s;
        }
        #photo-viewer-overlay .viewer-btn:hover { background: rgba(60,60,60,0.7); }
        #photo-viewer-overlay .viewer-content { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #photo-viewer-overlay #viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #photo-viewer-overlay .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 36px; height: 36px; font-size: 20px;
            opacity: 0.6; transition: opacity 0.2s;
        }
        #photo-viewer-overlay .nav-arrow:hover { opacity: 1; }
        #photo-viewer-overlay.wandering .nav-arrow { display: none; }
        #photo-viewer-overlay #prev-photo-btn { left: 15px; }
        #photo-viewer-overlay #next-photo-btn { right: 15px; }
        #photo-viewer-overlay .viewer-footer {
            padding: 20px; color: white; text-align: center;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        #photo-viewer-overlay #viewer-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        #photo-viewer-overlay #viewer-description { font-size: 14px; }
        #memoriesModal .empty-list-placeholder { grid-column: 1 / -1; text-align: center; color: #889; margin-top: 50px; }
        #memoriesModal .fab {
            position: absolute; right: 25px; bottom: 25px; width: 50px; height: 50px; border-radius: 50%;
            border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 4px 4px 8px var(--shadow-dark-day), -4px -4px 8px var(--shadow-light-day);
            background: var(--bg-day-element); color: var(--text-day); font-size: 28px;
            display: flex; align-items: center; justify-content: center; user-select: none; z-index: 100;
        }
        body.dark-mode #memoriesModal .fab {
            box-shadow: 4px 4px 8px var(--shadow-dark-night), -4px -4px 8px var(--shadow-light-night);
            background: var(--bg-night-element); color: var(--text-night);
        }
        #memoriesModal .fab:active { transform: scale(0.95); }
        #memoriesModal .modal-textarea{resize:vertical;min-height:80px;}
        #memoriesModal #upload-thumbnail { max-width: 100px; max-height: 100px; border-radius: 8px; margin: 0 auto; object-fit: cover; }
        #memoriesModal #note-editor-view {
            background: linear-gradient(135deg, var(--day-color1) 0%, var(--day-color2) 100%); z-index: 200;
            padding: 10px; transform: translateY(100%);
        }
        body.dark-mode #memoriesModal #note-editor-view {
            background: linear-gradient(135deg, var(--night-color1) 0%, var(--night-color2) 100%);
        }
        #memoriesModal #note-editor-view.active { transform: translateY(0); }
        #memoriesModal .editor-header{display:flex;justify-content:space-between;align-items:center;padding:10px 5px;flex-shrink:0}
        #memoriesModal .editor-btn{padding:10px 18px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;color:var(--hold-border);background:var(--bg-day-element);box-shadow:4px 4px 8px var(--shadow-dark-day),-4px -4px 8px var(--shadow-light-day);transition:all .2s ease}
        body.dark-mode #memoriesModal .editor-btn{color:var(--hold-border);background:var(--bg-night-element);box-shadow:4px 4px 8px var(--shadow-dark-night),-4px -4px 8px var(--shadow-light-night)}
        #memoriesModal .editor-btn:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-day),inset -4px -4px 8px var(--shadow-light-day)}
        body.dark-mode #memoriesModal .editor-btn:active{box-shadow:inset 4px 4px 8px var(--shadow-dark-night),inset -4px -4px 8px var(--shadow-light-night)}
        #memoriesModal #delete-note-btn{color:#f56565}
        #memoriesModal .editor-content{flex-grow:1;display:flex;flex-direction:column;gap:10px;padding:10px 5px}
        #memoriesModal #note-title-input, #memoriesModal #note-content-textarea{width:100%;border:none;background:transparent;color:inherit;font-size:18px;padding:10px}
        #memoriesModal #note-title-input{font-size:24px;font-weight:bold;flex-shrink:0}
        #memoriesModal #note-content-textarea{flex-grow:1;resize:none;line-height:1.6}
        #memoriesModal #note-title-input:focus, #memoriesModal #note-content-textarea:focus{outline:none}
    </style>
</head>
<body>
    <div class="page-overlay" id="pageOverlay"></div>
    <div class="title-card">
        <h1 class="editable-title" id="title">JellyfishCenter</h1>
        <div class="editable-subtitle" id="subtitle">长按☀️打开工具栏 | By淡季水母</div>
    </div>
    <div class="nav-container" id="navContainer">
        <p id="loading-status" style="text-align: center; color: #889; width: 100%;">正在从云端加载配置...</p>
    </div>

    <div class="fab-container" id="fabContainer">
        <div class="fab-drawer" id="fabDrawer">
            <button class="fab-drawer-item" id="helpBtn" title="使用指南">❓</button>
            <button class="fab-drawer-item" id="syncBtn" title="数据云盘">☁️<span id="sync-status-indicator" title="云同步状态"></span></button>
            <button class="fab-drawer-item" id="addNavBtn" title="管理小手机">📲</button>
            <button class="fab-drawer-item" id="colorBtn" title="主题设置">🎨</button>
            <!-- ========== [NEW] Memories Feature Button ========== -->
            <button class="fab-drawer-item" id="memoriesBtn" title="记忆">📷</button>
        </div>
        <button class="fab-main theme-toggle" id="themeBtn" title="切换主题">☀️</button>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="helpModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>使用指南</span></div><button class="close-btn" data-modal-id="helpModal">&times;</button></div><div class="modal-body">
        <input type="radio" id="help-tab-1" name="help-tab" value="setup" checked>
        <input type="radio" id="help-tab-2" name="help-tab" value="features">
        <input type="radio" id="help-tab-3" name="help-tab" value="disclaimer">

        <div class="segmented-control three-segments">
            <label for="help-tab-1">首次配置</label>
            <label for="help-tab-2">功能详解</label>
            <label for="help-tab-3">免责声明</label>
            <div class="slider-indicator"></div>
        </div>
        <div class="help-content-wrapper">
            <div id="help-page-1" class="help-page-content">
                <h3>从零开始 (必需)</h3><p>此流程将创建一个安全的“钥匙”(PAT)和两个云端“仓库”（一个用于代码，一个用于数据），让本应用可以为您安全地存储和同步所有数据。</p>
                <h4>步骤 1：创建 GitHub 个人访问令牌 (PAT)</h4><p>这个令牌是应用访问您私人云仓库的专属安全密码。</p><ol><li><strong>访问创建页面</strong>：<a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">点击此链接直接进入 GitHub Token 创建页面</a>。</li><li><strong>填写基本信息</strong>：备注(Note)填写 <code>JellyfishCenterToken</code>，有效期(Expiration)选择 <code>No expiration</code> (永不过期)。</li><li><strong>分配权限 (关键)</strong>：只需 <strong>勾选 <code>repo</code></strong> 这一项。</li><li><strong>生成并复制</strong>：滑动到页面最底部，点击 <strong><code>Generate token</code></strong> 按钮。<strong>【⚠️极其重要⚠️】</strong> GitHub 只会显示这一次完整的 Token。请 <strong>立即点击复制按钮</strong> 将其保存到安全的地方，下一步会马上用到。它应该以 <code>ghp_</code> 开头。</li></ol>
                <h4>步骤 2：复刻 (Fork) 应用代码仓库</h4><p>此步骤会将应用的核心代码复制一份到您的账户下，用于网站托管服务（如Netlify）进行构建。</p><ol><li><strong>访问仓库页面</strong>：在浏览器中打开 <a href="https://github.com/Yeexein/JellyfishPhones" target="_blank" rel="noopener noreferrer">https://github.com/Yeexein/JellyfishPhones</a>。</li><li><strong>执行 Fork 操作</strong>：<ul><li><strong>电脑端</strong>：在页面右上角，您会看到 `Watch`、`Fork`、`Star` 等按钮。点击 <strong><code>Fork</code></strong>。</li><li><strong>手机端</strong>：在页面顶部仓库名称下方，找到并点击 <strong><code>...</code> (更多选项)</strong> 菜单，然后在弹出的菜单中选择 <strong><code>Fork</code></strong>。</li></ul></li><li><strong>完成复刻</strong>：在接下来的页面中，您无需修改任何设置。直接点击 <strong><code>Create fork</code></strong> 按钮即可。</li></ol>
                <h4>步骤 3：创建私人数据仓库</h4><p>此步骤将创建一个独立的、完全私密的仓库，专门用来存放您的所有配置和文件。这可以避免因数据更新导致网站被频繁重新构建，是**一劳永逸的最佳实践**。</p><ol><li><strong>访问创建页面</strong>：<a href="https://github.com/new" target="_blank" rel="noopener noreferrer">点击此链接直接进入 GitHub 仓库创建页面</a>。</li><li><strong>填写仓库信息</strong>：<ul><li><strong>Repository name (仓库名称)</strong>：起一个清晰的名字，例如 <code>My-Jellyfish-Data</code>。</li><li><strong>关键：选择 <code>Private</code> (私有)</strong>。这是您的私人数据，必须设为私有。</li><li><strong>勾选 <code>Add a README file</code></strong>：确保仓库被成功初始化。</li></ul></li><li><strong>点击 <code>Create repository</code></strong> 按钮完成创建。</li></ol>
                <h4>步骤 4：在 JellyfishCenter 内完成最终配置</h4><p>现在，我们将“钥匙”和“数据仓库”信息告诉本应用。</p><ol><li><strong>打开配置面板</strong>：长按右下角的 ☀️/🌙 按钮展开菜单 → 点击 <strong>☁️ (数据云盘)</strong> → 点击标题旁的 <strong>⚙️ (设置)</strong>。</li><li><strong>填入信息</strong>：<ul><li><strong>仓库</strong>：填写您在 <strong>步骤3</strong> 创建的**私人数据仓库**地址，格式为 <code>你的GitHub用户名/My-Jellyfish-Data</code>。</li><li><strong>Personal Access Token</strong>：粘贴您在 <strong>步骤1</strong> 创建并复制好的完整 Token。</li></ul></li><li><strong>保存并同步</strong>：点击 <strong><code>保存配置</code></strong> 按钮。</li></ol><p><strong>恭喜！</strong> 您的 JellyfishCenter 现已与云端完全同步，并采用了最高效的架构。</p>
            </div>
            <div id="help-page-2" class="help-page-content">
                <h3>功能详解</h3><h4>1. 导航管理</h4><p><strong>添加新手机</strong>：长按主菜单 → 点击 📲 图标。可选择添加`外部链接`或`上传项目`。</p><p><strong>管理与删除</strong>：在“管理小手机”弹窗内，点击`进入管理模式`，即可对现有按钮进行排序或删除。</p><h4>2. 主题与个性化</h4><p><strong>实时调色</strong>：长按主菜单 → 点击 🎨 图标。可实时调整日间/夜间模式的背景渐变色。</p><p><strong>色彩预设</strong>：您可以保存、应用、更新或删除自己喜欢的配色方案，还可以开启“随机主题”功能。</p><h4>3. 文件云盘与同步状态</h4><p><strong>访问与管理</strong>：长按主菜单 → 点击 ☁️ 图标。您可以分门别类地管理与“上传项目”相关联的所有文件。建议用来存储备份文件。</p><p><strong>云同步状态指示灯</strong>：☁️ 图标上的小圆点会实时显示同步状态：</p><ul><li><strong>🟢 绿点</strong>: `已同步` - 所有本地更改都已成功保存到云端。</li><li><strong>🟡 黄点 (闪烁)</strong>: `同步中` - 正在与云端进行数据交换。</li><li><strong>🔴 红点</strong>: `同步失败` - 发生错误，请点击图标查看失败原因，通常是网络问题或PAT失效。</li></ul><h4>4. 基础操作</h4><p><strong>编辑标题</strong>：直接点击页面上的主标题或副标题即可修改。</p><p><strong>访问链接与返回</strong>：对于外部链接，会在应用内全屏打开。您可以从屏幕**最左侧边缘向右滑动**来关闭当前页面并返回中心。</p><p><strong>切换主题</strong>：**单击 (短按)** 右下角的 ☀️/🌙 按钮。</p><h4>5. 危险区域</h4><div class="warning"><p><strong>清空所有数据</strong>：在 `GitHub 配置` (⚙️) 弹窗的最下方。此操作会 **永久删除** 您 GitHub 数据仓库中所有相关数据。<strong>此操作不可逆，请极度谨慎</strong>。</p></div>
            </div>
            <div id="help-page-3" class="help-page-content">
                <h3>免责声明与使用条款</h3><h4>1. 服务条款</h4><p>本应用 (JellyfishCenter) 按“现状”提供，不附带任何明示或暗示的保证。开发者不保证应用的持续可用性、功能完整性或无错误。所有因使用本应用导致的直接或间接风险与责任，均由用户自行承担。</p><h4>2. 数据安全</h4><p>用户需自行负责其GitHub个人访问令牌 (PAT) 的安全保管。任何因PAT泄露导致的数据丢失、篡改或账户安全问题，开发者概不负责。强烈建议为本应用创建独立的、具有最小必要权限 (<code>repo</code>) 的PAT。</p><h4>3. 知识产权与版权责任</h4><div class="important-note"><p>本应用可能被用于托管或链接至第三方项目（“小手机”）。用户必须对所上传或链接的内容负全部法律责任，并确保拥有展示、使用和分发该内容的合法权利。<strong>用户必须尊重所有原创作者的知识产权，不得侵犯他人版权。</strong></p></div><h4>4. 使用与分发限制</h4><div class="warning"><p>本项目 (JellyfishCenter) 及其源代码仅供个人非商业性使用。严禁以下行为：</p><ul><li>对本项目的源代码进行任何形式的二次修改、再分发或公开发布（即“二传二改”）。</li><li>公开或私下分享通过本应用“上传项目”功能生成的任何网页链接或文件。此行为可能构成对原创内容的未授权分发。</li></ul></div><p>继续使用本应用，即表示您已阅读、理解并同意上述所有条款。</p>
            </div>
        </div>
    </div></div></div>
    <div class="modal-overlay" id="syncErrorModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>⚠️ 同步失败</span></div><button class="close-btn" data-modal-id="syncErrorModal">&times;</button></div><div class="modal-body"><p>无法连接到云端。请检查您的网络连接或GitHub配置。</p><p><strong>失败原因:</strong></p><div id="sync-error-message"></div></div></div></div>
    <div class="modal-overlay" id="addNavModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>管理小手机</span></div><div class="header-toggle-group"><span>连续添加</span><label class="toggle-switch"><input type="checkbox" id="stayOpenToggle"><span class="slider"></span></label></div><button class="close-btn" data-modal-id="addNavModal">&times;</button></div><div class="modal-body"><button id="enterManageModeBtn" class="modal-button" style="color:#5a6778;">进入管理模式</button><div class="segmented-control two-segments"><input type="radio" id="type-link" name="nav-type" value="link" checked hidden><label for="type-link">外部链接</label><input type="radio" id="type-upload" name="nav-type" value="upload" hidden><label for="type-upload">上传项目</label><div class="slider-indicator"></div></div><div class="form-section"><label for="newButtonNameInput">按钮名称</label><input type="text" id="newButtonNameInput" class="modal-input" placeholder="例如: 我的博客"></div><div id="link-section" class="form-section"><label for="newButtonUrlInput">网址链接</label><input type="text" id="newButtonUrlInput" class="modal-input" placeholder="https://example.com"></div><div id="upload-section" class="form-section" style="display: none;"><label>选择项目的主HTML文件</label><div class="file-select-wrapper"><input type="file" id="projectHtmlPicker" accept=".html,.htm" style="display: none;"><button id="filePickerBtn" class="modal-button">选择文件</button><span id="file-picker-status" class="status-text">未选择任何文件</span></div></div><button id="createNavBtn" class="modal-button">加入新手机</button><div class="status-text" id="upload-status"></div></div></div></div>
    <div class="modal-overlay" id="syncModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>数据云盘</span><button class="settings-btn" id="settingsBtn" title="设置GitHub信息">⚙️</button></div><button class="close-btn" data-modal-id="syncModal">&times;</button></div><div class="modal-body"><select id="buttonSelector" class="modal-select"></select><div class="file-upload-section"><input type="file" id="fileUploader"><div class="file-select-wrapper"><button id="selectFileBtn" class="modal-button">选择文件</button><span id="selectedFileName" class="status-text">未选择任何文件</span></div><input type="text" id="fileNameInput" class="modal-input" placeholder="可修改文件名（可选）"><button id="uploadBtn" class="modal-button">上传文件</button><div id="progressContainer" class="progress-container"><div id="uploadProgressBar" class="progress-bar"></div></div></div><div id="file-list-container"><ul id="fileList"></ul><div id="fileListStatus" class="file-list-status">请选择一个分类</div></div></div></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>GitHub 配置</span></div><button class="close-btn" data-modal-id="settingsModal">&times;</button></div><div class="modal-body"><div class="form-section"><label for="githubRepoInput">仓库 (格式: 用户名/仓库名)</label><input type="text" id="githubRepoInput" class="modal-input" placeholder="例如: my-username/JellyfishPhones"></div><div class="form-section"><label for="githubTokenInput">Personal Access Token</label><input type="password" id="githubTokenInput" class="modal-input" placeholder="ghp_xxxxxxxxxx"></div><button id="saveSettingsBtn" class="modal-button">保存配置</button><div class="nuke-section"><button id="nukeDataBtn" class="modal-button">清空所有云端及本地数据</button></div></div></div></div>
    <div class="modal-overlay" id="colorPaletteModal"><div class="modal-content"><div class="modal-header"><div class="modal-title-group"><span>主题设置</span></div><button class="close-btn" data-modal-id="colorPaletteModal">&times;</button></div><div class="modal-body"><div class="color-picker-grid"><div class="color-picker-group"><label>日间模式 - 左上</label><div class="color-input-wrapper"><input type="color" id="dayColor1Picker"><span class="hex-display" id="dayColor1Hex"></span></div></div><div class="color-picker-group"><label>日间模式 - 右下</label><div class="color-input-wrapper"><input type="color" id="dayColor2Picker"><span class="hex-display" id="dayColor2Hex"></span></div></div><div class="color-picker-group"><label>夜间模式 - 左上</label><div class="color-input-wrapper"><input type="color" id="nightColor1Picker"><span class="hex-display" id="nightColor1Hex"></span></div></div><div class="color-picker-group"><label>夜间模式 - 右下</label><div class="color-input-wrapper"><input type="color" id="nightColor2Picker"><span class="hex-display" id="nightColor2Hex"></span></div></div></div><div class="preview-container"><div class="preview-box" id="dayPreview" data-label="Day"></div><div class="preview-box" id="nightPreview" data-label="Night"></div></div><div class="preset-manager"><div class="preset-row"><input type="text" id="presetNameInput" class="modal-input" placeholder="为当前配色命名"><button id="savePresetBtn" class="modal-button save">保存</button><button id="updatePresetBtn" class="modal-button">更新</button></div><div class="preset-row"><select id="presetSelector" class="modal-select"></select><button id="deletePresetBtn" class="modal-button delete">删除</button></div></div><div class="random-toggle-section"><span>每次启动时随机应用预设</span><label class="toggle-switch"><input type="checkbox" id="randomPaletteToggle"><span class="slider"></span></label></div></div></div></div>

    <!-- ========== [NEW] Memories Feature Modal ========== -->
    <div class="modal-overlay" id="memoriesModal">
        <div class="modal-content">
            <div class="app-container">
                <!-- HUB / 入口页面 -->
                <div id="hub-view" class="page active">
                    <div class="page-header" style="justify-content: flex-end;">
                        <button class="header-btn close-btn" data-modal-id="memoriesModal">&times;</button>
                    </div>
                    <div id="hub-view-content">
                        <h1 class="title">记忆中心</h1>
                        <button id="goto-memo-btn" class="hub-btn">备忘录</button>
                        <button id="goto-album-btn" class="hub-btn">相册</button>
                    </div>
                </div>
                <!-- MEMO / 备忘录部分 -->
                <div id="memo-section" class="page">
                    <div id="folder-view" class="page active">
                        <div class="page-header">
                            <button class="header-btn back-btn" data-target="hub-view">&#10094;</button>
                            <h1 class="title">我的备忘录</h1>
                            <button id="manage-memo-folders-btn" class="header-btn manage-btn">管理</button>
                        </div>
                        <div id="folder-list-container" class="list-container"></div>
                        <button id="add-folder-fab" class="fab">+</button>
                    </div>
                    <div id="notes-view" class="page">
                        <div class="page-header">
                            <button class="header-btn back-btn" data-target="folder-view">&#10094;</button>
                            <h1 id="notes-view-title" class="title">文件夹</h1>
                        </div>
                        <div id="notes-list-container" class="list-container"></div>
                        <button id="add-note-fab" class="fab">+</button>
                    </div>
                    <div id="note-editor-view" class="page">
                        <div class="editor-header">
                            <button id="cancel-note-btn" class="editor-btn">取消</button>
                            <div>
                                <button id="delete-note-btn" class="editor-btn" style="display: none;">删除</button>
                                <button id="save-note-btn" class="editor-btn">完成</button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <input type="text" id="note-title-input" placeholder="标题">
                            <textarea id="note-content-textarea" placeholder="在这里输入内容..."></textarea>
                        </div>
                    </div>
                </div>
                <!-- ALBUM / 相册部分 -->
                <div id="album-section" class="page">
                    <div id="album-folder-view" class="page active">
                        <div class="page-header">
                            <button class="header-btn back-btn" data-target="hub-view">&#10094;</button>
                            <h1 class="title">我的相册</h1>
                            <div class="header-controls">
                                <button id="global-wander-btn" class="header-btn wander-btn">漫游</button>
                                <button id="manage-album-folders-btn" class="header-btn manage-btn">管理</button>
                            </div>
                        </div>
                        <div id="album-list-container" class="list-container"></div>
                        <button id="add-album-fab" class="fab">+</button>
                    </div>
                    <div id="photo-grid-view" class="page">
                         <div class="page-header">
                            <button class="header-btn back-btn" data-target="album-folder-view">&#10094;</button>
                            <h1 id="photo-grid-title" class="title">相册</h1>
                            <div class="header-controls">
                                <button id="local-wander-btn" class="header-btn wander-btn">漫游</button>
                            </div>
                        </div>
                        <div id="photo-list-container" class="list-container"></div>
                        <label for="photo-uploader" id="add-photo-fab" class="fab">+</label>
                        <input type="file" id="photo-uploader" multiple accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Generic folder modal for Memories -->
    <div class="modal-overlay" id="memories-folder-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div id="memories-folder-modal-title" class="modal-header" style="font-size: 20px; font-weight: 600;">新文件夹</div>
            <div class="modal-body" style="padding: 10px 0;">
                <input type="text" id="memories-folder-name-input" class="modal-input" placeholder="文件夹名称">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="modal-button" onclick="document.getElementById('memories-folder-modal').classList.remove('show')">取消</button>
                <button id="memories-save-folder-btn" class="modal-button" style="color: var(--hold-border);">保存</button>
            </div>
        </div>
    </div>
    <!-- Photo upload details modal -->
    <div class="modal-overlay" id="photo-details-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div id="photo-details-modal-title" class="modal-header" style="font-size: 20px; font-weight: 600;">添加照片信息</div>
            <div class="modal-body" style="padding: 10px 0;">
                <img id="upload-thumbnail" src="" alt="upload thumbnail" style="max-width: 100px; max-height: 100px; border-radius: 8px; margin: 0 auto; object-fit: cover;">
                <input type="text" id="photo-title-input" class="modal-input" placeholder="标题 (选填)">
                <textarea id="photo-desc-input" class="modal-input" style="resize: vertical; min-height: 80px;" placeholder="描述 (选填)"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="skip-photo-details-btn" class="modal-button">跳过</button>
                <button id="save-photo-details-btn" class="modal-button" style="color: var(--hold-border);">保存并继续</button>
            </div>
        </div>
    </div>
    <!-- Photo viewer overlay -->
    <div id="photo-viewer-overlay">
        <div class="viewer-header">
            <button id="close-viewer-btn" class="viewer-btn">✕</button>
        </div>
        <div class="viewer-content">
            <button id="prev-photo-btn" class="viewer-btn nav-arrow">&#10094;</button>
            <img id="viewer-img" src="" alt="Photo view">
            <button id="next-photo-btn" class="viewer-btn nav-arrow">&#10095;</button>
        </div>
        <div class="viewer-footer">
            <h3 id="viewer-title"></h3>
            <p id="viewer-description"></p>
        </div>
    </div>

    <!-- == Iframe Modal & Confirmation Toast == -->
    <div class="iframe-modal-overlay" id="iframeModal">
        <div id="returnConfirmationToast" class="return-toast">
            <span>返回 JellyfishCenter?</span>
            <div>
                <button id="cancelReturnBtn" class="toast-btn toast-btn-cancel">取消</button>
                <button id="confirmReturnBtn" class="toast-btn toast-btn-confirm">确认</button>
            </div>
        </div>
        <div class="iframe-modal-content">
            <iframe id="iframeContent" src="about:blank" frameborder="0" allow="fullscreen" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts"></iframe>
        </div>
        <div id="gestureCaptureZone"></div>
        <div class="swipe-hint" id="swipeHint"><div class="arrow"></div><span>向右滑动关闭</span></div>
    </div>

    <script>
    // [JS - V8.4.1 "Memories Feature Integration"]
    let GITHUB_CONFIG = {}, configSha = null, isManagementMode = false, isLongPress = false;
    let longPressTimer = null, sourceBtn = null, targetBtn = null, projectFile = null;
    const navContainer = document.getElementById('navContainer'), pageOverlay = document.getElementById('pageOverlay');
    const syncStatusIndicator = document.getElementById('sync-status-indicator');
    const syncErrorModal = document.getElementById('syncErrorModal');
    const iframeModal = document.getElementById('iframeModal'), iframeModalContent = iframeModal.querySelector('.iframe-modal-content'), iframeEl = document.getElementById('iframeContent'), swipeHint = document.getElementById('swipeHint'), returnConfirmationToast = document.getElementById('returnConfirmationToast');

    const getDefaultConfig = () => ({ title: 'JellyfishCenter', subtitle: '长按☀️打开工具栏 | By淡季水母', buttons: [], themePresets: [] });
    let currentConfig = getDefaultConfig();
    
    const utf8_to_b64 = (str) => btoa(unescape(encodeURIComponent(str)));
    const b64_to_utf8 = (str) => decodeURIComponent(escape(atob(str)));

    let syncStatusTimeout;
    function updateSyncStatus(status, message = '') {
        syncStatusIndicator.className = status;
        syncStatusIndicator.title = message || `云同步状态: ${status}`;
        clearTimeout(syncStatusTimeout);
        if (status === 'synced') {
            syncStatusTimeout = setTimeout(() => {
                syncStatusIndicator.className = '';
                syncStatusIndicator.title = '云同步状态: 已同步';
            }, 3000);
            syncErrorModal.classList.remove('show');
        } else if (status === 'error') {
            document.getElementById('sync-error-message').textContent = message;
            syncErrorModal.classList.add('show');
        }
    }

    const withCacheBust = (url) => `${url}${url.includes('?') ? '&' : '?'}v=${Date.now()}`;
    
    async function fetchFromGithub(path) {
        if (!checkConfig(false)) return null;
        const url = withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`);
        try {
            const response = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } });
            if (!response.ok) {
                if (response.status === 404) return { status: 404 };
                throw new Error(`${response.status}: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Failed to fetch ${path} from GitHub:`, error);
            updateSyncStatus('error', `读取 ${path} 失败: ${error.message}`);
            return null;
        }
    }

    async function saveToGithub(path, contentB64, commitMessage, sha) {
        if (!checkConfig(true)) return null;
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
        const body = { message: commitMessage, content: contentB64, branch: 'main' };
        if (sha) body.sha = sha;
        try {
            const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }, body: JSON.stringify(body) });
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ message: response.statusText }));
                 throw new Error(`${response.status}: ${errorData.message}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Failed to save ${path} to GitHub:`, error);
            updateSyncStatus('error', `写入 ${path} 失败: ${error.message}`);
            return null;
        }
    }
    
    async function deleteFromGithub(path, commitMessage, sha) {
        if (!checkConfig(true)) return false;
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
        try {
            const response = await fetch(url, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` },
                body: JSON.stringify({ message: commitMessage, sha: sha, branch: 'main' })
            });
            if (!response.ok && response.status !== 404) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(`${response.status}: ${errorData.message}`);
            }
            return true;
        } catch (error) {
            console.error(`Failed to delete ${path} from GitHub:`, error);
            updateSyncStatus('error', `删除 ${path} 失败: ${error.message}`);
            return false;
        }
    }

    async function fetchConfigFromGithub() {
        updateSyncStatus('syncing', '正在从云端读取配置...');
        const data = await fetchFromGithub('config.json');
        if (!data) return getDefaultConfig();
        if (data.status === 404) {
            console.log('Config.json not found. Auto-creating it now.');
            configSha = null;
            await saveGlobalConfig('Auto-create initial config.json');
            return getDefaultConfig();
        }
        configSha = data.sha;
        updateSyncStatus('synced', '配置读取成功');
        return JSON.parse(b6_to_utf8(data.content));
    }

    async function saveGlobalConfig(commitMessage) {
        updateSyncStatus('syncing', `正在同步: ${commitMessage}`);
        const content = utf8_to_b64(JSON.stringify(currentConfig, null, 2));
        const result = await saveToGithub('config.json', content, commitMessage, configSha);
        if (result) {
            configSha = result.content.sha;
            console.log('Global configuration saved successfully.');
            updateSyncStatus('synced', '同步成功！');
        }
    }
    
    function toggleManagementMode(forceState) { isManagementMode = forceState !== undefined ? forceState : !isManagementMode; pageOverlay.classList.toggle('show', isManagementMode); pageOverlay.classList.toggle('management-overlay', isManagementMode); document.body.classList.toggle('management-active', isManagementMode); document.querySelectorAll('.nav-btn').forEach(btn => { const deleteIcon = btn.querySelector('.delete-icon'); if (isManagementMode && !deleteIcon) { const icon = document.createElement('span'); icon.className = 'delete-icon'; icon.innerHTML = '&times;'; icon.title = '删除此按钮'; btn.appendChild(icon); } else if (!isManagementMode && deleteIcon) { deleteIcon.remove(); } }); }
    pageOverlay.addEventListener('click', (e) => { if (isManagementMode && !e.target.closest('.nav-btn')) { toggleManagementMode(false); } if (fabContainer.classList.contains('active')) { toggleFabMenu(false); } });
    const fabContainer = document.getElementById('fabContainer'), fabMainBtn = document.getElementById('themeBtn');
    let fabPressTimer = null, isFabLongPress = false;
    function toggleFabMenu(forceState) { const isActive = forceState !== undefined ? forceState : !fabContainer.classList.contains('active'); fabContainer.classList.toggle('active', isActive); if (!isManagementMode) pageOverlay.classList.toggle('show', isActive); }
    fabMainBtn.addEventListener('mousedown', (e) => { e.preventDefault(); isFabLongPress = false; fabPressTimer = setTimeout(() => { isFabLongPress = true; toggleFabMenu(true); }, 300); });
    fabMainBtn.addEventListener('mouseup', () => { clearTimeout(fabPressTimer); if (!isFabLongPress) { fabContainer.classList.contains('active') ? toggleFabMenu(false) : toggleTheme(); } });
    fabMainBtn.addEventListener('contextmenu', e => e.preventDefault());
    fabMainBtn.addEventListener('touchstart', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mousedown')); }, { passive: false });
    fabMainBtn.addEventListener('touchend', e => { e.preventDefault(); fabMainBtn.dispatchEvent(new MouseEvent('mouseup')); }, { passive: false });
    function clearHoldClass() { document.querySelectorAll('.nav-btn.hold').forEach(btn => btn.classList.remove('hold')); }
    async function swapButtons(a, b) { if (!a || !b || a === b) return; const parent = a.parentNode; const aNext = a.nextSibling; const bNext = b.nextSibling; if (aNext === b) { parent.insertBefore(b, a); } else if (bNext === a) { parent.insertBefore(a, b); } else { parent.insertBefore(b, aNext); parent.insertBefore(a, bNext); } updateButtonOrderAndSave('Reorder buttons'); }
    function updateButtonOrderAndSave(commitMessage) { const newOrder = []; document.querySelectorAll('.nav-btn').forEach(btn => newOrder.push({ text: btn.textContent.replace('×', '').trim(), href: btn.dataset.href })); currentConfig.buttons = newOrder; saveGlobalConfig(commitMessage); }
    
    function attachButtonListeners(btn) {
        btn.addEventListener('click', function(e) { if (isManagementMode || isLongPress) { e.preventDefault(); return; } const href = this.dataset.href; if (!href) return; if (href.startsWith('http')) { e.preventDefault(); openIframeModal(href); } else { window.location.href = href; } });
    }

    document.getElementById('enterManageModeBtn').addEventListener('click', () => { document.getElementById('addNavModal').classList.remove('show'); setTimeout(() => toggleManagementMode(true), 150); });
    navContainer.addEventListener('click', async (e) => { if (!e.target.classList.contains('delete-icon')) return; const btnToDelete = e.target.closest('.nav-btn'); const buttonName = btnToDelete.textContent.replace('×', '').trim(); if (!confirm(`确定要删除 "${buttonName}" 吗？\n警告：如果这是上传的项目，其在GitHub上的整个文件夹都将被永久删除！`)) return; btnToDelete.style.cssText = 'transition: all 0.3s ease; transform: scale(0.8); opacity: 0;'; setTimeout(async () => { btnToDelete.remove(); const href = btnToDelete.dataset.href; const isExternalLink = href.startsWith('http'); if (!isExternalLink && href.includes('/')) { const folderPath = href.substring(0, href.lastIndexOf('/')); const success = await deleteGithubFolder(folderPath); if (!success) { alert('删除云端文件夹失败!'); location.reload(); return; } } updateButtonOrderAndSave(`Delete button: ${buttonName}`); }, 300); });
    document.getElementById('title').addEventListener('click', () => { if(isManagementMode) return; const newTitle = prompt('新标题：', currentConfig.title); if (newTitle?.trim() && newTitle.trim() !== currentConfig.title) { document.getElementById('title').textContent = newTitle.trim(); currentConfig.title = newTitle.trim(); saveGlobalConfig('Update main title'); } });
    document.getElementById('subtitle').addEventListener('click', () => { if(isManagementMode) return; const newSubtitle = prompt('新描述：', currentConfig.subtitle); if (newSubtitle !== null && newSubtitle.trim() !== currentConfig.subtitle) { document.getElementById('subtitle').textContent = newSubtitle.trim(); currentConfig.subtitle = newSubtitle.trim(); saveGlobalConfig('Update subtitle'); } });
    function initTheme() { const t=localStorage.getItem('theme'); if (t==='dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark-mode'); fabMainBtn.textContent = '🌙'; } else { fabMainBtn.textContent = '☀️'; } }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); const i=document.body.classList.contains('dark-mode'); fabMainBtn.textContent=i?'🌙':'☀️'; localStorage.setItem('theme', i?'dark':'light'); };
    const colorModal = { pickerD1: document.getElementById('dayColor1Picker'), hexD1: document.getElementById('dayColor1Hex'), pickerD2: document.getElementById('dayColor2Picker'), hexD2: document.getElementById('dayColor2Hex'), pickerN1: document.getElementById('nightColor1Picker'), hexN1: document.getElementById('nightColor1Hex'), pickerN2: document.getElementById('nightColor2Picker'), hexN2: document.getElementById('nightColor2Hex'), presetName: document.getElementById('presetNameInput'), presetSelector: document.getElementById('presetSelector'), saveBtn: document.getElementById('savePresetBtn'), updateBtn: document.getElementById('updatePresetBtn'), deleteBtn: document.getElementById('deletePresetBtn'), randomToggle: document.getElementById('randomPaletteToggle'), dayPreview: document.getElementById('dayPreview'), nightPreview: document.getElementById('nightPreview') };
    const root = document.documentElement; function applyColors(colors, saveToLocal = true) { Object.entries(colors).forEach(([key, value]) => { const cssVar = `--${key.replace('Color', '-color')}`; root.style.setProperty(cssVar, value); if (saveToLocal) localStorage.setItem(key, value); }); updateColorUI(colors); }
    function updateColorUI(colors) { colorModal.pickerD1.value = colors.dayColor1; colorModal.hexD1.textContent = colors.dayColor1; colorModal.pickerD2.value = colors.dayColor2; colorModal.hexD2.textContent = colors.dayColor2; colorModal.pickerN1.value = colors.nightColor1; colorModal.hexN1.textContent = colors.nightColor1; colorModal.pickerN2.value = colors.nightColor2; colorModal.hexN2.textContent = colors.nightColor2; colorModal.dayPreview.style.background = `linear-gradient(135deg, ${colors.dayColor2}, ${colors.dayColor1})`; colorModal.nightPreview.style.background = `linear-gradient(135deg, ${colors.nightColor2}, ${colors.nightColor1})`; }
    function getCurrentColors(fromLocalStorage = true) { const source = fromLocalStorage ? localStorage : { getItem: (key) => getComputedStyle(root).getPropertyValue(`--${key.replace('Color', '-color')}`).trim() }; return { dayColor1: source.getItem('dayColor1') || '#f5f7fa', dayColor2: source.getItem('dayColor2') || '#e4eaf5', nightColor1: source.getItem('nightColor1') || '#1f2a40', nightColor2: source.getItem('nightColor2') || '#16213e', }; }
    function setupColorSync(picker, hexDisplay, key) { picker.addEventListener('input', () => { hexDisplay.textContent = picker.value; applyColors({ ...getCurrentColors(), [key]: picker.value }); }); }
    function loadColorState() { populatePresetDropdown(); const randomPaletteEnabled = localStorage.getItem('randomPaletteEnabled') === 'true'; colorModal.randomToggle.checked = randomPaletteEnabled; if (randomPaletteEnabled && currentConfig.themePresets && currentConfig.themePresets.length > 0) { const randomPreset = currentConfig.themePresets[Math.floor(Math.random() * currentConfig.themePresets.length)]; applyColors(randomPreset.colors, false); } else { applyColors(getCurrentColors()); } }
    function populatePresetDropdown() { colorModal.presetSelector.innerHTML = '<option value="">选择一个预设...</option>'; (currentConfig.themePresets || []).forEach((p, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = p.name; colorModal.presetSelector.appendChild(opt); }); }
    colorModal.saveBtn.addEventListener('click', () => { const name = colorModal.presetName.value.trim(); if (!name) return alert('请输入预设名称'); if ((currentConfig.themePresets || []).some(p => p.name === name)) return alert('预设名称已存在'); if (!currentConfig.themePresets) currentConfig.themePresets = []; currentConfig.themePresets.push({ name, colors: getCurrentColors(false) }); saveGlobalConfig(`Save theme preset: ${name}`); populatePresetDropdown(); colorModal.presetSelector.value = currentConfig.themePresets.length - 1; colorModal.presetName.value = ''; });
    colorModal.updateBtn.addEventListener('click', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return alert('请选择一个预设'); const name = colorModal.presetName.value.trim() || currentConfig.themePresets[index].name; currentConfig.themePresets[index] = { name, colors: getCurrentColors(false) }; saveGlobalConfig(`Update theme preset: ${name}`); populatePresetDropdown(); colorModal.presetSelector.value = index; });
    colorModal.deleteBtn.addEventListener('click', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return alert('请选择一个预设'); const presetName = currentConfig.themePresets[index].name; if (!confirm(`确定删除云端预设 "${presetName}"?`)) return; currentConfig.themePresets.splice(index, 1); saveGlobalConfig(`Delete theme preset: ${presetName}`); populatePresetDropdown(); });
    colorModal.presetSelector.addEventListener('change', () => { const index = colorModal.presetSelector.value; if (index === '' || !currentConfig.themePresets) return; applyColors(currentConfig.themePresets[index].colors); colorModal.presetName.value = currentConfig.themePresets[index].name; });
    colorModal.randomToggle.addEventListener('change', () => { localStorage.setItem('randomPaletteEnabled', colorModal.randomToggle.checked); });
    const syncModalElements = { buttonSelector: document.getElementById("buttonSelector"), fileList: document.getElementById("fileList"), fileListStatus: document.getElementById("fileListStatus"), fileUploader: document.getElementById("fileUploader"), selectFileBtn: document.getElementById("selectFileBtn"), selectedFileName: document.getElementById("selectedFileName"), fileNameInput: document.getElementById("fileNameInput"), uploadBtn: document.getElementById("uploadBtn"), progressContainer: document.getElementById("progressContainer"), progressBar: document.getElementById("uploadProgressBar"), githubRepoInput: document.getElementById("githubRepoInput"), githubTokenInput: document.getElementById("githubTokenInput"), saveSettingsBtn: document.getElementById("saveSettingsBtn") };
    function setupModals(){document.querySelectorAll(".close-btn").forEach(e=>e.addEventListener("click",()=>{document.getElementById(e.dataset.modalId).classList.remove("show")})),document.querySelectorAll(".modal-overlay").forEach(e=>e.addEventListener("click",t=>{if(e===t.target&&e.id!=="photo-viewer-overlay"){e.classList.remove("show")}})),document.getElementById("helpBtn").addEventListener("click",()=>{document.getElementById("helpModal").classList.add("show"),toggleFabMenu(!1)}),document.getElementById("syncBtn").addEventListener("click",()=>{document.getElementById("syncModal").classList.add("show"),populateButtonSelector(),fetchFilesForSelectedButton(),toggleFabMenu(!1)}),document.getElementById("settingsBtn").addEventListener("click",()=>{GITHUB_CONFIG.owner&&GITHUB_CONFIG.repo&&(syncModalElements.githubRepoInput.value=`${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`),syncModalElements.githubTokenInput.value=GITHUB_CONFIG.token||"",document.getElementById("settingsModal").classList.add("show")}),document.getElementById("addNavBtn").addEventListener("click",()=>{document.getElementById("addNavModal").classList.add("show"),toggleFabMenu(!1)}),document.getElementById("colorBtn").addEventListener("click",()=>{document.getElementById("colorPaletteModal").classList.add("show"),updateColorUI(getCurrentColors()),toggleFabMenu(!1)})}
    function saveGithubConfig(e){localStorage.setItem("githubConfig",JSON.stringify(e)),GITHUB_CONFIG=e}function loadGithubConfig(){const e=localStorage.getItem("githubConfig");e&&(GITHUB_CONFIG=JSON.parse(e))}function checkConfig(e=!0){return!GITHUB_CONFIG.owner||!GITHUB_CONFIG.repo||!GITHUB_CONFIG.token?(e&&alert("请先配置GitHub仓库信息。\n(打开菜单 -> 数据云盘 -> 标题旁⚙️)"),!1):!0}
    async function loadInitialData() { navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889;">正在从云端加载配置...</p>'; const fetchedConfig = await fetchConfigFromGithub(); currentConfig = { ...getDefaultConfig(), ...fetchedConfig }; document.getElementById('title').textContent = currentConfig.title; document.getElementById('subtitle').textContent = currentConfig.subtitle; document.querySelector('.editable-title').style.opacity = 1; document.querySelector('.editable-subtitle').style.opacity = 1; navContainer.innerHTML = ''; if (!currentConfig.buttons || currentConfig.buttons.length === 0) { navContainer.innerHTML = '<p id="loading-status" style="text-align: center; color: #889;">配置为空，请添加导航按钮。</p>'; } else { currentConfig.buttons.forEach(item => addNewButtonToDOM(item.text, item.href, false)); } loadColorState(); }
    async function deleteGithubFolder(folderPath) { if (!checkConfig(true)) return false; updateSyncStatus('syncing', `正在删除文件夹: ${folderPath}`); const contentsUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${folderPath}`; try { const contentsResponse = await fetch(withCacheBust(contentsUrl), { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } }); if (contentsResponse.status === 404) return true; if (!contentsResponse.ok) throw new Error(`无法列出文件夹内容: ${contentsResponse.statusText}`); const files = await contentsResponse.json(); for (const file of files) { if (file.type === 'dir') { await deleteGithubFolder(file.path); } else { await deleteFromGithub(file.path, `Delete ${file.name}`, file.sha); } } updateSyncStatus('synced', `文件夹 ${folderPath} 已删除`); return true; } catch (error) { console.error(`删除文件夹 "${folderPath}" 失败:`, error); updateSyncStatus('error', `删除文件夹失败: ${error.message}`); return false; } }
    syncModalElements.saveSettingsBtn.addEventListener("click",async()=>{const[e,t]=syncModalElements.githubRepoInput.value.trim().split("/").map(e=>e.trim()),n=syncModalElements.githubTokenInput.value.trim();if(e&&t&&n){saveGithubConfig({owner:e,repo:t,token:n,branch:"main"}),alert("配置已保存！刷新页面加载云端配置。"),document.getElementById("settingsModal").classList.remove("show"),await loadInitialData()}else{alert("请填写完整信息。")}});function populateButtonSelector(){const e=syncModalElements.buttonSelector.value;syncModalElements.buttonSelector.innerHTML="",document.querySelectorAll(".nav-btn").forEach(t=>{const n=t.textContent.replace("×","").trim(),o=document.createElement("option");o.value=o.textContent=n,syncModalElements.buttonSelector.appendChild(o)}),Array.from(syncModalElements.buttonSelector.options).some(t=>t.value===e)&&(syncModalElements.buttonSelector.value=e)}
    syncModalElements.buttonSelector.addEventListener("change",fetchFilesForSelectedButton); syncModalElements.selectFileBtn.addEventListener('click', () => syncModalElements.fileUploader.click());
    syncModalElements.fileUploader.addEventListener("change",()=>{ if(syncModalElements.fileUploader.files.length>0){ const file = syncModalElements.fileUploader.files[0]; syncModalElements.fileNameInput.value=file.name; syncModalElements.selectedFileName.textContent = file.name; } else { syncModalElements.selectedFileName.textContent = "未选择任何文件"; }});
    async function fetchFilesForSelectedButton(){const e=syncModalElements.buttonSelector.value;if(syncModalElements.fileList.innerHTML="",syncModalElements.fileListStatus.style.display="block",!e)return void(syncModalElements.fileListStatus.textContent="请选择一个分类");if(!checkConfig(!0))return void(syncModalElements.fileListStatus.innerHTML="尚未配置GitHub信息<br>请点击标题旁 ⚙️");syncModalElements.fileListStatus.textContent="正在加载...";const t=withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data_sync/${e}`);try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`}});if(404===n.status)return void(syncModalElements.fileListStatus.textContent="该分类下暂无文件");if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.json();if(0===o.length)syncModalElements.fileListStatus.textContent="该分类下暂无文件";else{const l=await Promise.all(o.map(async e=>({...e,commitDate:await getLatestCommitDate(e.path)})));l.sort((e,t)=>new Date(t.commitDate)-new Date(e.commitDate)),syncModalElements.fileList.innerHTML="",syncModalElements.fileListStatus.style.display="none",l.forEach(e=>{const t=document.createElement("li"),n=document.createElement("div");n.className="file-info",n.dataset.downloadUrl=e.download_url,n.dataset.fileName=e.name;const o=document.createElement("span");o.className="file-name",o.textContent=e.name;const l=document.createElement("span");l.className="file-timestamp",l.textContent=(new Date(e.commitDate)).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),n.append(o,l);const a=document.createElement("button");a.className="delete-btn",a.innerHTML="&times;",a.title="删除文件",t.append(n,a),syncModalElements.fileList.appendChild(t),n.addEventListener("click",t=>forceDownload(t.currentTarget.dataset.downloadUrl,t.currentTarget.dataset.fileName,n)),a.addEventListener("click",()=>deleteFile(e.path,e.sha,t))})}}catch(n){console.error("获取文件列表失败:",n),syncModalElements.fileListStatus.textContent="加载失败，请检查网络或配置。"}}
    async function getLatestCommitDate(e){const t=withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/commits?path=${encodeURIComponent(e)}&page=1&per_page=1`);try{const n=await fetch(t,{headers:{"Authorization":`token ${GITHUB_CONFIG.token}`}});if(!n.ok)return(new Date(0)).toISOString();const o=await n.json();return o[0]?.commit.committer.date||(new Date(0)).toISOString()}catch(n){return console.error(`Error fetching commit date for ${e}:`,n),(new Date(0)).toISOString()}}async function deleteFile(e,t,n){if(!confirm(`确定要永久删除文件 "${e.split("/").pop()}" 吗？`))return;n.style.opacity="0.5";const success = await deleteFromGithub(e, `Delete file: ${e}`, t); if(success) { n.remove(); if (syncModalElements.fileList.children.length === 0) { syncModalElements.fileListStatus.textContent = "该分类下暂无文件"; syncModalElements.fileListStatus.style.display = "block"; } } else { alert(`删除文件失败`); n.style.opacity = "1"; } }async function forceDownload(e,t,n){const o=n.querySelector(".file-name").textContent;n.querySelector(".file-name").textContent="准备下载...";n.style.pointerEvents="none";try{const l=await fetch(e);if(!l.ok)throw new Error(`下载请求失败: ${l.statusText}`);const a=await l.blob(),c=document.createElement("a");c.href=window.URL.createObjectURL(a),c.download=t,document.body.appendChild(c),c.click(),c.remove(),window.URL.revokeObjectURL(c.href)}catch(l){console.error("Download error:",l),alert(`下载出错: ${l.message}`)}finally{n.querySelector(".file-name").textContent=o,n.style.pointerEvents="auto"}}
    function uploadFileWithProgress(url, fileContent, token, commitMessage, sha) { return new Promise((resolve, reject) => { const body = { message: commitMessage, content: fileContent, branch: "main" }; if(sha) body.sha = sha; const xhr = new XMLHttpRequest(); xhr.open("PUT", url, true); xhr.setRequestHeader("Authorization", `token ${token}`); xhr.setRequestHeader("Content-Type", "application/json"); xhr.upload.onprogress = (event) => { if (event.lengthComputable) { const percentComplete = (event.loaded / event.total) * 100; syncModalElements.progressBar.style.width = percentComplete + '%'; } }; xhr.onload = () => { if (xhr.status >= 200 && xhr.status < 300) { resolve(JSON.parse(xhr.responseText)); } else { reject(new Error(`上传失败: ${xhr.statusText} - ${xhr.responseText}`)); } }; xhr.onerror = () => reject(new Error("网络错误，上传失败。")); xhr.send(JSON.stringify(body)); }); }
    syncModalElements.uploadBtn.addEventListener("click", async () => { if (!checkConfig()) return; const category = syncModalElements.buttonSelector.value; const file = syncModalElements.fileUploader.files[0]; let fileName = syncModalElements.fileNameInput.value.trim() || (file && file.name); if (!category || !file || !fileName) { return alert("请选择分类、文件，并确保文件名不为空。"); } syncModalElements.uploadBtn.disabled = true; syncModalElements.uploadBtn.textContent = "上传中..."; syncModalElements.progressContainer.style.display = 'block'; syncModalElements.progressBar.style.width = '0%'; try { const content = await fileToBase64(file); const url = withCacheBust(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data_sync/${category}/${fileName}`); await uploadFileWithProgress(url, content, GITHUB_CONFIG.token, `Upload ${fileName}`); syncModalElements.uploadBtn.textContent = '正在处理...'; setTimeout(() => { alert("上传成功！"); syncModalElements.fileUploader.value = ""; syncModalElements.fileNameInput.value = ""; syncModalElements.selectedFileName.textContent = '未选择任何文件'; fetchFilesForSelectedButton(); }, 200); } catch (error) { console.error("上传失败:", error); alert(`上传失败: ${error.message}`); } finally { setTimeout(() => { syncModalElements.uploadBtn.disabled = false; syncModalElements.uploadBtn.textContent = "上传文件"; syncModalElements.progressContainer.style.display = 'none'; }, 1000); } });
    const addNavModalElements={typeLinkRadio:document.getElementById("type-link"),typeUploadRadio:document.getElementById("type-upload"),linkSection:document.getElementById("link-section"),uploadSection:document.getElementById("upload-section"),nameInput:document.getElementById("newButtonNameInput"),urlInput:document.getElementById("newButtonUrlInput"),filePickerBtn:document.getElementById("filePickerBtn"),projectHtmlPicker:document.getElementById("projectHtmlPicker"),fileStatus:document.getElementById("file-picker-status"),createBtn:document.getElementById("createNavBtn"),uploadStatus:document.getElementById("upload-status"),stayOpenToggle:document.getElementById("stayOpenToggle")};
    function addNewButtonToDOM(text, href, save=true) { navContainer.querySelector("#loading-status")?.remove(); const btn = document.createElement("button"); btn.className = "nav-btn"; btn.textContent = text; btn.dataset.href = href; navContainer.appendChild(btn); attachButtonListeners(btn); if (isManagementMode) { const icon = document.createElement('span'); icon.className = 'delete-icon'; icon.innerHTML = '&times;'; icon.title = '删除此按钮'; btn.appendChild(icon); } if (save) { if(!currentConfig.buttons) currentConfig.buttons = []; currentConfig.buttons.push({text, href}); saveGlobalConfig(`Add button: ${text}`); } }
    function resetAddNavForm() { addNavModalElements.nameInput.value = ""; addNavModalElements.urlInput.value = ""; addNavModalElements.fileStatus.textContent = "未选择任何文件"; addNavModalElements.uploadStatus.textContent = ""; addNavModalElements.projectHtmlPicker.value = ""; projectFile = null; }
    
    document.querySelectorAll('input[name="nav-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            addNavModalElements.linkSection.style.display = this.value === 'link' ? 'flex' : 'none';
            addNavModalElements.uploadSection.style.display = this.value === 'upload' ? 'flex' : 'none';
        });
    });

    addNavModalElements.filePickerBtn.addEventListener("click", () => addNavModalElements.projectHtmlPicker.click()); addNavModalElements.projectHtmlPicker.addEventListener("change", () => { if (addNavModalElements.projectHtmlPicker.files.length > 0) { projectFile = addNavModalElements.projectHtmlPicker.files[0]; addNavModalElements.fileStatus.textContent = `已选择: ${projectFile.name}`; } else { projectFile = null; addNavModalElements.fileStatus.textContent = '未选择任何文件'; }});
    function fileToBase64(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result.split(",")[1]),o.onerror=n,o.readAsDataURL(e)})}
    addNavModalElements.createBtn.addEventListener("click",async()=>{const e=addNavModalElements.nameInput.value.trim();if(!e)return void alert("请输入按钮名称。");const t=document.querySelector('input[name="nav-type"]:checked').value;addNavModalElements.createBtn.disabled=!0,addNavModalElements.createBtn.textContent="处理中...";try{let n;if("link"===t){const o=addNavModalElements.urlInput.value.trim();if(!o)return void alert("请输入网址链接。");n={text:e,href:o}}else if("upload"===t){if(!checkConfig())return;if(!projectFile)return void alert("请选择一个HTML文件。");addNavModalElements.uploadStatus.textContent="正在上传文件...";const path=e.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g,"").replace(/\s+/g,"-")||`project-${Date.now()}`; const content_b64=await fileToBase64(projectFile); const result = await saveToGithub(`${path}/index.html`, content_b64, `Create project: ${e}`); if(!result) throw new Error("Upload failed"); addNavModalElements.uploadStatus.textContent="正在处理...";n={text:e,href:`${path}/index.html`};alert("项目上传发布成功！")} addNewButtonToDOM(n.text, n.href); resetAddNavForm(); if(!addNavModalElements.stayOpenToggle.checked) { document.getElementById("addNavModal").classList.remove("show"); } }catch(o){console.error("创建失败:",o),alert(`操作失败: ${o.message}`),addNavModalElements.uploadStatus.textContent="操作失败!"}finally{addNavModalElements.createBtn.disabled=!1,addNavModalElements.createBtn.textContent="加入新手机"}});
    
    // --- Iframe Modal and Confirmation Logic ---
    function openIframeModal(url) { if (!localStorage.getItem('swipeHintShown')) { swipeHint.classList.add('show'); setTimeout(() => { swipeHint.classList.remove('show'); localStorage.setItem('swipeHintShown', 'true'); }, 4000); } iframeEl.src = url; iframeModal.classList.add('active'); }
    function closeIframeModal() { hideReturnConfirmation(); iframeModal.classList.remove('active'); setTimeout(() => { iframeEl.src = 'about:blank'; }, 400); }
    function showReturnConfirmation() { returnConfirmationToast.classList.add('show'); }
    function hideReturnConfirmation() { returnConfirmationToast.classList.remove('show'); }
    document.getElementById('confirmReturnBtn').addEventListener('click', closeIframeModal);
    document.getElementById('cancelReturnBtn').addEventListener('click', hideReturnConfirmation);

    const gestureCaptureZone = document.getElementById('gestureCaptureZone'); let startX = 0, currentX = 0, isDragging = false;
    gestureCaptureZone.addEventListener('touchstart', (e) => { isDragging = true; startX = e.touches[0].clientX; iframeModalContent.classList.add('dragging'); }, { passive: true });
    window.addEventListener('touchmove', (e) => { if (!isDragging || returnConfirmationToast.classList.contains('show')) return; e.preventDefault(); currentX = e.touches[0].clientX; const diffX = currentX - startX; if (diffX > 0) { iframeModalContent.style.transform = `translateX(${diffX}px)`; } }, { passive: false }); 
    window.addEventListener('touchend', (e) => { if (!isDragging) return; isDragging = false; iframeModalContent.classList.remove('dragging'); iframeModalContent.style.transform = ''; const diffX = currentX - startX; const closeThreshold = window.innerWidth / 3.5; if (diffX > closeThreshold && !returnConfirmationToast.classList.contains('show')) { showReturnConfirmation(); } startX = 0; currentX = 0; });

    async function nukeAllData() {
        if (!checkConfig(true)) return;
        const confirmation = prompt("⚠️ 极度危险操作！\n\n这将永久删除您所有的数据，包括所有按钮、预设、上传的文件和项目、以及所有“记忆”数据。\n\n此操作不可逆，将使应用恢复到空白的初始状态。如确认，请输入“确认删除”：");
        if (confirmation !== "确认删除") { alert("操作已取消。"); return; }

        try {
            updateSyncStatus('syncing', '正在执行重置...');
            const rootContentsUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/`;
            const rootContentsRes = await fetch(withCacheBust(rootContentsUrl), { headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` } });
            if (rootContentsRes.ok) {
                const items = await rootContentsRes.json();
                const deletionPromises = [];

                const configItem = items.find(item => item.name === 'config.json');
                if (configItem) {
                    deletionPromises.push(deleteFromGithub(configItem.path, 'NUKE: Deleting config file', configItem.sha));
                }

                for (const item of items) {
                    if (item.type === 'dir' && !['.github', 'icons'].includes(item.name)) {
                        deletionPromises.push(deleteGithubFolder(item.path));
                    }
                }
                await Promise.all(deletionPromises);
            }
            localStorage.clear();
            alert('所有数据已清空。页面将刷新。');
            location.reload();
        } catch (error) {
            console.error('Nuke operation failed:', error);
            updateSyncStatus('error', `重置失败: ${error.message}`);
            alert(`重置操作失败: ${error.message}`);
        }
    }
    document.getElementById('nukeDataBtn').addEventListener('click', nukeAllData);
    
    // ========== [NEW] Memories Feature Logic ==========
    const setupMemoriesApp = () => {
        const MEMORIES_DB_PATH = 'memories_data/db.json';
        let memoriesDbSha = null;
        let state = {};

        const dom = {
            modal: document.getElementById('memoriesModal'),
            folderModal: document.getElementById('memories-folder-modal'),
            photoDetailsModal: document.getElementById('photo-details-modal'),
            viewerOverlay: document.getElementById('photo-viewer-overlay'),
            memo: {
                folderList: document.getElementById('folder-list-container'),
                notesList: document.getElementById('notes-list-container'),
                manageBtn: document.getElementById('manage-memo-folders-btn'),
                notesViewTitle: document.getElementById('notes-view-title'),
                noteTitleInput: document.getElementById('note-title-input'),
                noteContentTextarea: document.getElementById('note-content-textarea'),
                deleteNoteBtn: document.getElementById('delete-note-btn')
            },
            album: {
                folderList: document.getElementById('album-list-container'),
                photoList: document.getElementById('photo-list-container'),
                manageBtn: document.getElementById('manage-album-folders-btn'),
                photoGridTitle: document.getElementById('photo-grid-title'),
                uploader: document.getElementById('photo-uploader')
            },
            viewer: {
                img: document.getElementById('viewer-img'),
                title: document.getElementById('viewer-title'),
                description: document.getElementById('viewer-description')
            }
        };

        function getInitialState() {
            return {
                isMemoManageMode: false, currentMemoFolderId: null, currentNoteId: null,
                isAlbumManageMode: false, currentAlbumId: null,
                currentPhoto: { albumPhotos: [], photoIndex: -1 },
                photoUploadQueue: [],
                data: {
                    memo: { folders: [], notes: [] },
                    album: { folders: [], photos: [] }
                }
            };
        }

        async function loadMemoriesData() {
            updateSyncStatus('syncing', '正在加载记忆...');
            const result = await fetchFromGithub(MEMORIES_DB_PATH);
            if (!result) { // Error occurred
                state.data = getInitialState().data;
                return;
            }
            if (result.status === 404) { // Not found, create new
                state.data = getInitialState().data;
                state.data.memo.folders.push({ id: Date.now(), name: "默认文件夹" });
                state.data.album.folders.push({ id: Date.now() + 1, name: "我的照片" });
                memoriesDbSha = null;
                await saveMemoriesData('Initial memories database');
            } else {
                memoriesDbSha = result.sha;
                state.data = JSON.parse(b6_to_utf8(result.content));
            }
            updateSyncStatus('synced', '记忆加载完成');
        }

        async function saveMemoriesData(commitMessage) {
            updateSyncStatus('syncing', `正在保存记忆: ${commitMessage}`);
            const content = utf8_to_b64(JSON.stringify(state.data, null, 2));
            const result = await saveToGithub(MEMORIES_DB_PATH, content, commitMessage, memoriesDbSha);
            if (result) {
                memoriesDbSha = result.content.sha;
                updateSyncStatus('synced', '记忆保存成功');
            }
        }
        
        function showPage(pageId, contextPage) {
            dom.modal.querySelectorAll('.app-container > .page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (contextPage) {
                contextPage.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                contextPage.classList.add('active');
            }
        }

        function showView(viewId, sectionId) {
            const section = document.getElementById(sectionId);
            section.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            showPage(sectionId);
        }

        dom.modal.addEventListener('click', e => {
            const target = e.target;
            if (target.matches('.back-btn')) {
                const targetViewId = target.dataset.target;
                if (targetViewId === 'hub-view') showPage('hub-view');
                else showView(targetViewId, target.closest('.page.active').id);
            }
            if (target.id === 'goto-memo-btn') { renderMemoFolders(); showView('folder-view', 'memo-section'); }
            if (target.id === 'goto-album-btn') { renderAlbumFolders(); showView('album-folder-view', 'album-section'); }
        });

        // --- MEMO LOGIC ---
        function renderMemoFolders() {
            dom.memo.folderList.innerHTML = state.data.memo.folders.length === 0 
                ? `<p class="empty-list-placeholder">没有文件夹</p>`
                : state.data.memo.folders.map(f => `
                    <div class="folder-item" data-folder-id="${f.id}">
                        <div class="folder-icon">📁</div><div class="folder-name">${f.name}</div>
                        <div class="delete-icon" data-action="delete-memo-folder">×</div>
                    </div>`).join('');
        }
        function renderNotes() {
            const notesInFolder = state.data.memo.notes.filter(n => n.folderId === state.currentMemoFolderId).sort((a, b) => b.timestamp - a.timestamp);
            dom.memo.notesList.innerHTML = notesInFolder.length === 0 
                ? `<p class="empty-list-placeholder">没有笔记</p>`
                : notesInFolder.map(n => {
                    const preview = n.content.substring(0, 100);
                    const date = new Date(n.timestamp).toLocaleDateString('zh-CN');
                    return `<div class="note-item" data-note-id="${n.id}">
                                <div class="note-title">${n.title || '无标题'}</div>
                                <div class="note-preview">${preview || '没有内容'}</div>
                                <div class="note-timestamp">${date}</div>
                            </div>`;
                }).join('');
        }
        dom.memo.manageBtn.addEventListener('click', () => {
            state.isMemoManageMode = !state.isMemoManageMode;
            dom.memo.folderList.classList.toggle('manage', state.isMemoManageMode);
            dom.memo.manageBtn.textContent = state.isMemoManageMode ? '完成' : '管理';
        });
        dom.memo.folderList.addEventListener('click', async e => {
            const folderItem = e.target.closest('.folder-item');
            if (!folderItem) return;
            const folderId = Number(folderItem.dataset.folderId);
            if (state.isMemoManageMode) {
                if (e.target.dataset.action === 'delete-memo-folder') {
                    const folder = state.data.memo.folders.find(f => f.id === folderId);
                    if (confirm(`确定删除文件夹 "${folder.name}" 及其所有笔记吗？`)) {
                        state.data.memo.folders = state.data.memo.folders.filter(f => f.id !== folderId);
                        state.data.memo.notes = state.data.memo.notes.filter(n => n.folderId !== folderId);
                        await saveMemoriesData(`Delete memo folder: ${folder.name}`);
                        renderMemoFolders();
                    }
                }
            } else {
                state.currentMemoFolderId = folderId;
                dom.memo.notesViewTitle.textContent = state.data.memo.folders.find(f => f.id === folderId).name;
                renderNotes();
                showView('notes-view', 'memo-section');
            }
        });
        dom.memo.notesList.addEventListener('click', e => {
            const noteItem = e.target.closest('.note-item');
            if (noteItem) {
                state.currentNoteId = Number(noteItem.dataset.noteId);
                const note = state.data.memo.notes.find(n => n.id === state.currentNoteId);
                dom.memo.noteTitleInput.value = note.title;
                dom.memo.noteContentTextarea.value = note.content;
                dom.memo.deleteNoteBtn.style.display = 'inline-block';
                showView('note-editor-view', 'memo-section');
            }
        });
        document.getElementById('add-note-fab').addEventListener('click', () => {
            state.currentNoteId = null;
            dom.memo.noteTitleInput.value = '';
            dom.memo.noteContentTextarea.value = '';
            dom.memo.deleteNoteBtn.style.display = 'none';
            showView('note-editor-view', 'memo-section');
        });
        document.getElementById('save-note-btn').addEventListener('click', async () => {
            const title = dom.memo.noteTitleInput.value.trim();
            const content = dom.memo.noteContentTextarea.value.trim();
            let commitMessage;
            if (state.currentNoteId) {
                const note = state.data.memo.notes.find(n => n.id === state.currentNoteId);
                note.title = title; note.content = content; note.timestamp = Date.now();
                commitMessage = `Update note: ${title || 'Untitled'}`;
            } else {
                if (!title && !content) { showView('notes-view', 'memo-section'); return; }
                state.data.memo.notes.push({ id: Date.now(), folderId: state.currentMemoFolderId, title, content, timestamp: Date.now() });
                commitMessage = `Create note: ${title || 'Untitled'}`;
            }
            await saveMemoriesData(commitMessage);
            renderNotes();
            showView('notes-view', 'memo-section');
        });
        document.getElementById('cancel-note-btn').addEventListener('click', () => showView('notes-view', 'memo-section'));
        dom.memo.deleteNoteBtn.addEventListener('click', async () => {
            if (!confirm('确定删除此笔记？')) return;
            const note = state.data.memo.notes.find(n => n.id === state.currentNoteId);
            state.data.memo.notes = state.data.memo.notes.filter(n => n.id !== state.currentNoteId);
            await saveMemoriesData(`Delete note: ${note.title || 'Untitled'}`);
            renderNotes();
            showView('notes-view', 'memo-section');
        });

        // --- ALBUM LOGIC ---
        function renderAlbumFolders() {
            dom.album.folderList.innerHTML = state.data.album.folders.length === 0
                ? `<p class="empty-list-placeholder">没有相册</p>`
                : state.data.album.folders.map(f => {
                    const photoCount = state.data.album.photos.filter(p => p.albumId === f.id).length;
                    return `<div class="album-item" data-album-id="${f.id}">
                                <div>
                                    <div class="folder-icon">🖼️</div><div class="folder-name">${f.name}</div>
                                </div>
                                <div class="album-info">${photoCount} 张照片</div>
                                <div class="delete-icon" data-action="delete-album-folder">×</div>
                            </div>`;
                }).join('');
        }
        function renderPhotos() {
            const photosInAlbum = state.data.album.photos.filter(p => p.albumId === state.currentAlbumId).sort((a, b) => b.timestamp - a.timestamp);
            dom.album.photoList.innerHTML = photosInAlbum.length === 0
                ? `<p class="empty-list-placeholder">没有照片</p>`
                : photosInAlbum.map(p => {
                    const photoUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/main/${p.path}`;
                    return `<div class="photo-item" data-photo-id="${p.id}" style="background-image: url(${withCacheBust(photoUrl)})"></div>`;
                }).join('');
        }
        dom.album.manageBtn.addEventListener('click', () => {
            state.isAlbumManageMode = !state.isAlbumManageMode;
            dom.album.folderList.classList.toggle('manage', state.isAlbumManageMode);
            dom.album.manageBtn.textContent = state.isAlbumManageMode ? '完成' : '管理';
        });
        dom.album.folderList.addEventListener('click', async e => {
            const albumItem = e.target.closest('.album-item');
            if (!albumItem) return;
            const albumId = Number(albumItem.dataset.albumId);
            if (state.isAlbumManageMode) {
                if (e.target.dataset.action === 'delete-album-folder') {
                    const album = state.data.album.folders.find(f => f.id === albumId);
                    if (confirm(`确定删除相册 "${album.name}" 及其所有照片吗？`)) {
                        const photosToDelete = state.data.album.photos.filter(p => p.albumId === albumId);
                        for(const photo of photosToDelete) {
                            await deleteFromGithub(photo.path, `Delete photo: ${photo.id}`, photo.sha);
                        }
                        state.data.album.folders = state.data.album.folders.filter(f => f.id !== albumId);
                        state.data.album.photos = state.data.album.photos.filter(p => p.albumId !== albumId);
                        await saveMemoriesData(`Delete album: ${album.name}`);
                        renderAlbumFolders();
                    }
                }
            } else {
                state.currentAlbumId = albumId;
                dom.album.photoGridTitle.textContent = state.data.album.folders.find(f => f.id === albumId).name;
                renderPhotos();
                showView('photo-grid-view', 'album-section');
            }
        });
        dom.album.photoList.addEventListener('click', e => {
            const photoItem = e.target.closest('.photo-item');
            if (photoItem) openPhotoViewer(Number(photoItem.dataset.photoId), { wander: false });
        });

        // --- FOLDER MODAL (Generic) ---
        let editingFolder = { type: null, id: null };
        function openFolderModal(type, id = null) {
            editingFolder = { type, id };
            const titleEl = document.getElementById('memories-folder-modal-title');
            const inputEl = document.getElementById('memories-folder-name-input');
            if (id) {
                const folder = state.data[type].folders.find(f => f.id === id);
                titleEl.textContent = '重命名文件夹'; inputEl.value = folder.name;
            } else {
                titleEl.textContent = type === 'memo' ? '新备忘录文件夹' : '新相册'; inputEl.value = '';
            }
            dom.folderModal.classList.add('show'); inputEl.focus();
        }
        document.getElementById('add-folder-fab').addEventListener('click', () => openFolderModal('memo'));
        document.getElementById('add-album-fab').addEventListener('click', () => openFolderModal('album'));
        document.getElementById('memories-save-folder-btn').addEventListener('click', async () => {
            const name = document.getElementById('memories-folder-name-input').value.trim();
            if (!name) return;
            const { type, id } = editingFolder;
            let commitMessage;
            if (id) {
                state.data[type].folders.find(f => f.id === id).name = name;
                commitMessage = `Rename ${type} folder to ${name}`;
            } else {
                state.data[type].folders.push({ id: Date.now(), name });
                commitMessage = `Create ${type} folder: ${name}`;
            }
            await saveMemoriesData(commitMessage);
            if (type === 'memo') renderMemoFolders();
            if (type === 'album') renderAlbumFolders();
            dom.folderModal.classList.remove('show');
        });

        // --- PHOTO UPLOAD & DETAILS ---
        dom.album.uploader.addEventListener('change', e => {
            const files = e.target.files;
            if (!files.length) return;
            state.photoUploadQueue = Array.from(files);
            processPhotoUploadQueue();
            e.target.value = '';
        });
        function processPhotoUploadQueue() {
            if (state.photoUploadQueue.length === 0) { renderPhotos(); renderAlbumFolders(); return; }
            const file = state.photoUploadQueue[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('upload-thumbnail').src = event.target.result;
                document.getElementById('photo-title-input').value = '';
                document.getElementById('photo-desc-input').value = '';
                dom.photoDetailsModal.dataset.imageDataUrl = event.target.result;
                document.getElementById('photo-details-modal-title').textContent = `添加照片信息 (${state.photoUploadQueue.length} 待处理)`;
                dom.photoDetailsModal.classList.add('show');
            };
            reader.readAsDataURL(file);
        }
        async function saveUploadedPhoto(skip = false) {
            const title = skip ? '' : document.getElementById('photo-title-input').value.trim();
            const description = skip ? '' : document.getElementById('photo-desc-input').value.trim();
            const imageDataUrl = dom.photoDetailsModal.dataset.imageDataUrl;
            const photoId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const photoPath = `memories_data/photos/${photoId}.png`;
            const contentB64 = imageDataUrl.split(',')[1];
            
            updateSyncStatus('syncing', `正在上传照片 ${photoId}...`);
            const result = await saveToGithub(photoPath, contentB64, `Upload photo ${photoId}`);
            if (result) {
                state.data.album.photos.push({
                    id: photoId, albumId: state.currentAlbumId, title, description,
                    path: result.content.path, sha: result.content.sha, timestamp: Date.now()
                });
                await saveMemoriesData(`Add photo metadata for ${photoId}`);
                state.photoUploadQueue.shift();
                dom.photoDetailsModal.classList.remove('show');
                processPhotoUploadQueue();
            } else {
                alert('照片上传失败，请检查网络和GitHub配置后重试。');
            }
        }
        document.getElementById('save-photo-details-btn').addEventListener('click', () => saveUploadedPhoto(false));
        document.getElementById('skip-photo-details-btn').addEventListener('click', () => saveUploadedPhoto(true));

        // --- PHOTO VIEWER ---
        function openPhotoViewer(photoId, options = { wander: false, scope: 'local' }) {
            dom.viewerOverlay.classList.toggle('wandering', options.wander);
            dom.viewerOverlay.dataset.wanderScope = options.scope;
            let photo;
            if (options.wander) {
                const photoPool = options.scope === 'global' ? state.data.album.photos : state.data.album.photos.filter(p => p.albumId === state.currentAlbumId);
                if(photoPool.length === 0) return;
                photo = photoPool[Math.floor(Math.random() * photoPool.length)];
            } else {
                state.currentPhoto.albumPhotos = state.data.album.photos.filter(p => p.albumId === state.currentAlbumId).sort((a, b) => b.timestamp - a.timestamp);
                state.currentPhoto.photoIndex = state.currentPhoto.albumPhotos.findIndex(p => p.id === photoId);
                photo = state.currentPhoto.albumPhotos[state.currentPhoto.photoIndex];
            }
            if (photo) {
                updatePhotoInViewer(photo);
                dom.viewerOverlay.classList.add('active');
            }
        }
        function updatePhotoInViewer(photo) {
            if (!photo) return;
            const photoUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/main/${photo.path}`;
            dom.viewer.img.src = withCacheBust(photoUrl);
            dom.viewer.title.textContent = photo.title || '';
            dom.viewer.description.textContent = photo.description || '';
        }
        document.getElementById('global-wander-btn').addEventListener('click', () => openPhotoViewer(null, { wander: true, scope: 'global' }));
        document.getElementById('local-wander-btn').addEventListener('click', () => openPhotoViewer(null, { wander: true, scope: 'local' }));
        document.getElementById('close-viewer-btn').addEventListener('click', () => dom.viewerOverlay.classList.remove('active'));
        document.getElementById('prev-photo-btn').addEventListener('click', () => {
            state.currentPhoto.photoIndex = (state.currentPhoto.photoIndex - 1 + state.currentPhoto.albumPhotos.length) % state.currentPhoto.albumPhotos.length;
            updatePhotoInViewer(state.currentPhoto.albumPhotos[state.currentPhoto.photoIndex]);
        });
        document.getElementById('next-photo-btn').addEventListener('click', () => {
            state.currentPhoto.photoIndex = (state.currentPhoto.photoIndex + 1) % state.currentPhoto.albumPhotos.length;
            updatePhotoInViewer(state.currentPhoto.albumPhotos[state.currentPhoto.photoIndex]);
        });
        let touchStartX = 0;
        dom.viewerOverlay.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
        dom.viewerOverlay.addEventListener('touchend', e => {
            let deltaX = e.changedTouches[0].clientX - touchStartX;
            if (Math.abs(deltaX) > 50) {
                if (dom.viewerOverlay.classList.contains('wandering')) {
                    openPhotoViewer(null, { wander: true, scope: dom.viewerOverlay.dataset.wanderScope });
                } else {
                    if (deltaX > 0) document.getElementById('prev-photo-btn').click();
                    else document.getElementById('next-photo-btn').click();
                }
            }
        });

        // --- INIT ---
        document.getElementById('memoriesBtn').addEventListener('click', async () => {
            if (!checkConfig()) return;
            toggleFabMenu(false);
            state = getInitialState();
            await loadMemoriesData();
            showPage('hub-view');
            dom.modal.classList.add('show');
        });
    };

    window.addEventListener('load', async () => {
        initTheme(); 
        loadGithubConfig();
        await loadInitialData();
        setupModals();
        setupColorSync(colorModal.pickerD1, colorModal.hexD1, 'dayColor1'); 
        setupColorSync(colorModal.pickerD2, colorModal.hexD2, 'dayColor2');
        setupColorSync(colorModal.pickerN1, colorModal.hexN1, 'nightColor1'); 
        setupColorSync(colorModal.pickerN2, colorModal.hexN2, 'nightColor2');
        
        // Initialize the new Memories feature
        setupMemoriesApp();
    });
    </script>
</body>
</html>
